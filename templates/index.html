<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SCLOG ‚Äî Programme Workflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body {
      background-color: #f4f6f9;
    }

    /* ===== HEADER (SAME AS CLO-ONLY) ===== */
    .app-header {
      background: linear-gradient(135deg, #1f3c88, #274b9f);
      color: white;
      padding: 1rem 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .app-header h5 {
      margin: 0;
      font-weight: 600;
    }

    .app-header small {
      opacity: 0.85;
      font-size: 0.85rem;
    }

    /* ===== CARD ===== */
    .app-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.08);
      padding: 1.75rem;
    }

    .step-title {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .step-desc {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 1rem;
    }

    .form-label {
      font-weight: 500;
    }

    hr {
      margin: 2rem 0;
    }
  </style>
</head>

<body>


  <header class="app-header">
  <div class="app-header-inner">

    <div class="app-brand">
      <i class="bi bi-stars"></i>
      <div>
        <div class="app-title">SCLOG</div>
        <div class="app-subtitle">
          Smart Course Learning Outcome Generator
        </div>
      </div>
    </div>

    <div class="header-actions">
      <a href="/" class="btn btn-outline-light btn-sm">‚Üê Back</a>
      <button id="darkToggle" class="btn btn-outline-light btn-sm">
        <i class="bi bi-moon"></i>
      </button>
    </div>

  </div>
</header>
 


    
<!-- STEP 1 ¬∑ Programme Context -->
<div class="card-box mb-3">

  <div class="d-flex align-items-center gap-2 mb-1">
    <span class="step-pill">STEP 1</span>
    <div class="step-header mb-0">Programme Context</div>
  </div>

  <div class="step-desc">
    Define the Discipline, Programme Level, Institutional Educational Goals (IEG),
    and Programme Educational Objectives (PEO) to guide appropriate outcome mapping.
  </div>

  <div class="step-divider"></div>

  <div class="row g-3 profile-row">

    <!-- Academic Profile -->
    <div class="col-12 col-md-4">
      <label class="form-label">Discipline (programme context)</label>
      <select id="profile" class="form-select">
        <option value="">Select Academic profile</option>
        <option value="health">Medical & Health</option>
        <option value="sc">Computer Science & IT</option>
        <option value="eng">Engineering & Technology</option>
        <option value="socs">Social Sciences</option>
        <option value="edu">Education</option>
        <option value="bus">Business & Management</option>
        <option value="arts">Arts & Humanities</option>
      </select>
    </div>

    <!-- Programme Level -->
    <div class="col-12 col-md-2">
      <label class="form-label">Programme Level</label>
      <select id="level" class="form-select">
        <option value="">Select Level</option>
        <option>Diploma</option>
        <option>Degree</option>
        <option>Master</option>
        <option>PhD</option>
      </select>
    </div>

    <!-- Programme Name -->
    <div class="col-12 col-md-6">
      <label class="form-label">Programme Name</label>
      <input
        id="programmeName"
        type="text"
        class="form-control"
        placeholder="e.g. Bachelor of Exercise Science">
    </div>

    <!-- IEG -->
    <div class="col-12">
      <label class="form-label">Institutional Educational Goals (IEG)</label>
      <textarea
        id="ieg_input"
        class="form-control"
        rows="3"
        placeholder="Paste or type Institutional Educational Goals here (optional)">
      </textarea>
      <div class="muted mt-1" style="font-size:0.85rem">
        Optional. This will be included in the generated CLO documentation.
      </div>
    </div>


    <!-- Generate PEO -->
    <div class="col-12">
      <button id="generatePEO" class="btn btn-outline-primary">
        Suggest Programme Educational Objectives (PEOs)
      </button>
    </div>

    <!-- PEO suggestions -->
    <div id="peoSuggestions" class="col-12"></div>

    <!-- Select PEO -->
    <div class="col-12 col-md-6">
      <label class="form-label mt-3">Select PEO</label>
      <select id="peoSelect" class="form-select"></select>
    </div>

    <!-- PEO rationale box -->
    <div id="ieg_peo_logic" class="logic-box d-none col-12"></div>

  </div>
</div>

    

    <!-- 2) PLO for selected PEO -->

      <!-- STEP 2 -->
<div class="card-box mb-3">

  <div class="d-flex align-items-center gap-2 mb-1">
    <span class="step-pill">STEP 2</span>
    <div class="step-header mb-0">
      Programme Learning Outcomes (PLO)
    </div>
  </div>

  <div class="step-desc">
    Select the Programme Learning Outcome (PLO) aligned with the selected
    Programme Educational Objective (PEO).
  </div>

  <div class="step-divider"></div>


  <label class="form-label">PLO for selected PEO</label>
  <select id="plo" class="form-select mb-3">
    <option value="">Select PLO</option>
  </select>

  <!-- Alignment rationale -->
  <div class="mb-3">
    <div class="form-label">Why is this PLO aligned with the selected PEO?</div>
    <div id="peo_plo_logic" class="logic-box">‚Äî</div>
  </div>

  <!-- Statements & indicator -->
<div class="mb-3">
  <h6 class="fw-bold mt-3">PLO and Indicator of Achievement</h6>

  <div>
    <strong>PLO:</strong>
    <span id="plo_statement" class="muted">‚Äî</span>
  </div>

  <div class="mt-2">
    <strong>PLO Indicator:</strong>
    <span id="plo_indicator" class="muted">‚Äî</span>
  </div>
</div>


   </div> <!-- ‚úÖ END STEP 2 card-box -->

    
    <!-- 3) Smart CLO Builder (main) -->
    
  <div class="card-box mb-3">

    <div class="d-flex align-items-center gap-2 mb-1">
  <span class="step-pill">STEP 3</span>
  <div class="step-header mb-0">
    Course Learning Outcome (CLO)
  </div>
</div>

<div class="step-desc">
  Construct a measurable Course Learning Outcome using Bloom‚Äôs Taxonomy,
  suitable action verbs, and clear content focus.
</div>

    <div class="d-flex align-items-center gap-2 mt-3 mb-1">
  <h5 class="smart-title mb-0">
    <i class="bi bi-lightning-charge-fill me-1"></i>
    Smart CLO Builder
  </h5>
  <span id="bloomTag" class="bloom-tag">‚Äî</span>
</div>

<div class="smart-divider mb-2"></div>
     


          
          <div class="muted mb-2">Create measurable course learning outcomes quickly</div>

          <ul class="nav nav-tabs mb-3" id="tabNav" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#builderTab">Builder</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#variantsTab">Variants</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#assessmentTab">Assessment</button></li>
          </ul>

          <div class="tab-content">
            <!-- BUILDER -->
            <div class="tab-pane fade show active" id="builderTab">
              <div class="row g-3">
                <div class="col-md-6">
  <label class="form-label">Bloom</label>
  <select id="bloom" class="form-select">
    <option value="">Select Bloom</option>
  </select>

  <!-- Bloom description (UI only) -->
  <div id="bloom_desc" class="muted mt-1" style="font-size:0.85rem;">
    Select a Bloom level to see its description.
  </div>
</div>

                <div id="bloom_level_guidance"
     class="mt-2 p-2 rounded"
     style="font-size:0.85rem; background:#f8f5ff;"></div>

                
              

                <div class="col-md-6">
                  <label class="form-label">Verb</label>
                  <select id="verb" class="form-select"><option value="">Select Verb</option></select>
                </div> 


                <label class="form-label">Course Name</label>
<input id="courseName"
  class="form-control"
  placeholder="e.g. Exercise Physiology II">

                
            
                  <div id="content_inline_suggestions"
     class="mt-2 muted"
     style="font-size:0.85rem">
</div>
                <div class="col-12">
                  <label class="form-label">
  Content (learning focus / object)
</label>
<div class="muted mb-1" style="font-size:0.85rem">
  Specify <strong>what</strong> the student will work on (procedure, concept,
  skill, case, or professional task).
</div>
<input id="content" class="form-control"
       placeholder="e.g., ECG waveform interpretation, laboratory testing procedure, ethical case scenario">
</div>
                <div class="col-12 d-flex gap-2 align-items-center">
                  <button id="generateBtn" class="btn btn-primary"><i class="bi bi-magic me-1"></i> Generate CLO</button>
                  <button id="copyBtn" class="btn btn-outline-secondary"><i class="bi bi-clipboard me-1"></i> Copy</button>
                  <div id="busy" class="muted" style="display:none">Generating‚Ä¶</div>
                </div>

                <div id="cloCard" class="col-12 card-box" style="display:none; margin-top:12px;">
                  <h6 class="mb-2">Generated CLO</h6>
                  <div id="clo_text" style="line-height:1.4; font-weight:600;"></div>

                  <div class="mt-3">
                    <button id="toggleVariants" class="btn btn-outline-secondary btn-sm">Show variants</button>
                    <div id="variantsPanel" style="display:none; margin-top:10px;"></div>
                  </div>

                  <div class="mt-3 d-flex gap-2">
                    <button id="downloadBtn" class="btn btn-success"><i class="bi bi-download me-1"></i> Download CLO</button>
                    <button id="downloadRubricBtn" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-text me-1"></i> Download Rubric</button>
                  </div>
                </div>

              </div>
            </div>

            <!-- VARIANTS -->
            <div class="tab-pane fade" id="variantsTab">
              <div id="variants_list" class="muted">Variants will appear after generating a CLO.</div>
            </div>

            <!-- ASSESSMENT -->
<div class="tab-pane fade" id="assessmentTab">

  <div class="step-header">Step 4 ¬∑ Assessment & Evidence</div>
  <div class="step-desc">
    Recommended assessment methods and supporting evidence aligned with
    the selected Bloom‚Äôs domain and CLO.
  </div>
  <div class="step-divider"></div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card-box">
        <h6>Suggested Assessment methods</h6>
        <div id="assess_list" class="muted">‚Äî</div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card-box">
        <h6>Suggested evidence</h6>
        <div id="evidence_list" class="muted">‚Äî</div>
      </div>
    </div>
  </div>

</div>
      

    <footer>¬© 2025 ‚Ä¢ Assoc Prof Dr Hazwani Ahmad Yusof @ Hanafi ‚Äî Universiti Sains Malaysia (USM)</footer>
  </div>


    
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script>
/* =========================
   SHORT HELPER
========================= */
const $ = id => document.getElementById(id);

/* =========================
   VBE + BLOOM BY LEVEL (SINGLE SOURCE)
========================= */
const VBE_BY_LEVEL = {
  Diploma:{
    bloom:{
      C:["remember","understand","apply"],
      A:["receiving","responding"],
      P:["perception","set","guided response"]
    },
    values:["discipline","responsibility"],
    focus:"work readiness and ethical conduct"
  },

  Degree:{
    bloom:{
      C:["understand","apply","analyze"],
      A:["responding","valuing"],
      P:["guided response","mechanism"]
    },
    values:["integrity","justice"],
    focus:"professional practice and societal responsibility"
  },

  Master:{
    bloom:{
      C:["analyze","evaluate","create"],
      A:["valuing","organization"],
      P:["mechanism","adaptation"]
    },
    values:["wisdom","accountability"],
    focus:"advanced professional judgement and leadership"
  },

  PhD:{
    bloom:{
      C:["create"],
      A:["characterization"],
      P:["adaptation","origination"]
    },
    values:["truth","global responsibility"],
    focus:"knowledge creation and ethical leadership"
  }
};

/* =========================
   UNIVERSAL PLO + VBE (MQF 2.0)
========================= */

const UNIVERSAL_PLO_MAP = {
  PLO1: {
    domain: "Knowledge and Understanding",
    vbe: "Ethics and Professionalism",
    statement: programme =>
      `In the context of the ${programme} programme, graduates demonstrate comprehensive and systematic understanding of relevant knowledge, concepts and principles to address complex and contemporary issues in professional practice.`,
    indicator: [
      "‚â• 70% of students achieve competent or above in assessments mapped to PLO1",
      "Achievement in assessments requiring integration and application of programme-level knowledge"
    ]
  },

  PLO2: {
    domain: "Cognitive Skills",
    vbe: "Ethics and Professionalism",
    statement: programme =>
      `In the context of the ${programme} programme, graduates analyse, evaluate and generate solutions or new knowledge through critical and independent inquiry that meets recognised academic or professional standards.`,
    indicator: [
      "‚â• 70% of students achieve competent or above in analytical, evaluative or research-based assessments",
      "Performance in higher-order cognitive tasks demonstrating critical and independent inquiry"
    ]
  },

  PLO3: {
    domain: "Practical Skills",
    vbe: "Compliance with Standards",
    statement: programme =>
      `In the context of the ${programme} programme, graduates demonstrate appropriate practical, technical or methodological skills in accordance with established standards and best practices.`,
    indicator: [
      "‚â• 70% of students achieve competent or above in practical or skills-based assessments",
      "Demonstration of competence aligned with established standards and best practices"
    ]
  },

  PLO4: {
    domain: "Interpersonal Skills",
    vbe: "Honesty and Integrity",
    statement: programme =>
      `In the context of the ${programme} programme, graduates work effectively and ethically with diverse individuals and teams in professional and scholarly environments.`,
    indicator: [
      "‚â• 70% of students achieve competent or above in group-based or teamwork-related assessments",
      "Effective and ethical collaboration in team-based activities"
    ]
  },

  PLO5: {
    domain: "Communication Skills",
    vbe: "Honesty and Integrity",
    statement: programme =>
      `In the context of the ${programme} programme, graduates communicate ideas, information and findings clearly, professionally and ethically to relevant stakeholders.`,
    indicator: [
      "‚â• 70% of students achieve competent or above in written and oral communication assessments",
      "Clarity, accuracy and professionalism in communication outputs"
    ]
  },

  PLO6: {
    domain: "Digital Skills",
    vbe: "Proper Ethics and Etiquette",
    statement: programme =>
      `In the context of the ${programme} programme, graduates apply appropriate digital and technological tools responsibly to support learning, professional practice or research.`,
    indicator: [
      "‚â• 70% of students demonstrate competent and ethical use of digital tools in assessments",
      "Responsible application of technology in coursework or projects"
    ]
  },

  PLO7: {
    domain: "Numeracy Skills",
    vbe: "Ethics and Professionalism",
    statement: programme =>
      `In the context of the ${programme} programme, graduates apply appropriate quantitative or analytical methods to interpret data and support informed decision-making.`,
    indicator: [
      "‚â• 70% of students achieve competent or above in quantitative or data analysis assessments",
      "Accurate interpretation and application of numerical data"
    ]
  },

  PLO8: {
    domain: "Leadership, Autonomy and Responsibility",
    vbe: "Honesty and Integrity",
    statement: programme =>
      `In the context of the ${programme} programme, graduates demonstrate leadership, autonomy and accountability in professional, academic or organisational contexts.`,
    indicator: [
      "‚â• 70% of students demonstrate competent leadership, autonomy or responsibility in assessments",
      "Evidence of independent decision-making or accountability"
    ]
  },

  PLO9: {
    domain: "Personal Skills",
    vbe: "Flexibility and Adaptability",
    statement: programme =>
      `In the context of the ${programme} programme, graduates engage in lifelong learning and self-development through reflective and adaptive practices.`,
    indicator: [
      "‚â• 70% of students demonstrate satisfactory reflective or self-development practices",
      "Evidence of lifelong learning and adaptability"
    ]
  },

  PLO10: {
    domain: "Entrepreneurship Skills",
    vbe: "Honesty and Integrity",
    statement: programme =>
      `In the context of the ${programme} programme, graduates apply entrepreneurial or innovative approaches to identify opportunities and create value within their field.`,
    indicator: [
      "‚â• 70% of students demonstrate innovative or entrepreneurial thinking in projects or assignments",
      "Identification of opportunities or value-creating solutions"
    ]
  },

  PLO11: {
    domain: "Ethics and Professionalism",
    vbe: "Ethics and Professionalism",
    statement: programme =>
      `In the context of the ${programme} programme, graduates uphold ethical principles, professional standards and responsible conduct in all areas of practice.`,
    indicator: [
      "‚â• 70% of students demonstrate ethical and professional behaviour in assessments and coursework",
      "No major disciplinary or ethical violations affecting learning outcomes"
    ]
  }
};

    

/* =========================
   PROGRAMME EDUCATIONAL OBJECTIVES (PEO)
   Evaluated 3‚Äì5 years after graduation
========================= */

const PROGRAMME_PEO_MAP = {
  PEO1: {
    focus: "Employability and Professional Practice",
    indicators: [
      "‚â• 70% of graduates employed in relevant professional fields within 6‚Äì12 months of graduation",
      "Positive employer feedback on graduates‚Äô professional competence",
      "Graduates meet minimum professional or practice standards"
    ],
    dataSource: [
      "Graduate Tracer Study",
      "Employer Survey"
    ]
  },

  PEO2: {
    focus: "Communication and Teamwork",
    indicators: [
      "‚â• 70% of employers rate graduates as competent or above in communication and teamwork",
      "Effective participation in multidisciplinary or team-based work environments",
      "Evidence of effective professional communication in workplace settings"
    ],
    dataSource: [
      "Employer Survey",
      "Industry Advisory Panel Feedback"
    ]
  },

  PEO3: {
    focus: "Leadership and Lifelong Learning",
    indicators: [
      "Graduates assume leadership or supervisory roles within 3‚Äì5 years",
      "Graduates engage in continuing professional development or postgraduate studies",
      "Independent decision-making in professional practice"
    ],
    dataSource: [
      "Alumni Survey",
      "Professional Body Records"
    ]
  },

  PEO4: {
    focus: "Innovation and Value Creation",
    indicators: [
      "Graduates contribute to innovation, service improvement, or new initiatives",
      "Involvement in entrepreneurial, research, or improvement projects",
      "Application of creative and problem-solving skills in professional contexts"
    ],
    dataSource: [
      "Alumni Feedback",
      "Employer Survey"
    ]
  },

  PEO5: {
    focus: "Ethics and Professionalism",
    indicators: [
      "Graduates demonstrate ethical and professional conduct with no major disciplinary issues",
      "Employers report high integrity and professionalism among graduates",
      "Compliance with professional codes, regulations, and standards"
    ],
    dataSource: [
      "Employer Survey",
      "Alumni Feedback",
      "Professional Body Input"
    ]
  }
};

    
  const PEO_PLO_MAP = {
  PEO1: ["PLO1", "PLO2", "PLO3", "PLO6", "PLO7"],
  PEO2: ["PLO4", "PLO5"],
  PEO3: ["PLO8", "PLO9"],
  PEO4: ["PLO10"],
  PEO5: ["PLO11"]
};  



    
/* =========================
   DOM REFERENCES
========================= */
const profileSel = $('profile');
const levelSel = $('level');
const iegSel = $('ieg_input');
const ploSel = $('plo');

const bloomSel = $('bloom');
const verbSel = $('verb');
const contentInput = $('content');

const iegLogicBox = $('ieg_peo_logic');
const peoPloLogicBox = $('peo_plo_logic');

const ploStatementEl = $('plo_statement');
const ploIndicatorEl = $('plo_indicator');
const generateBtn = $('generateBtn');
const copyBtn = $('copyBtn');
const busyEl = $('busy');
const cloCard = $('cloCard');
const cloText = $('clo_text');
const toggleVariantsBtn = $('toggleVariants');
const variantsPanel = $('variantsPanel');
const variants_list = $('variants_list');

const assessList = $('assess_list');
const evidenceList = $('evidence_list');

const downloadBtn = $('downloadBtn');
const downloadRubricBtn = $('downloadRubricBtn');
const darkToggle = $('darkToggle');
const peoSuggestions = $('peoSuggestions');
const peoSelect = $('peoSelect');  



const bloomDescEl = $('bloom_desc');

/* =========================
   STATE
========================= */
let MAP = {};
let LAST_CLO = null;
let IEG_TEXT = ""; 
let COURSE_NAME = "";


/* =========================
   BLOOM DESCRIPTIONS
========================= */
const BLOOM_DESC = {
  /* Cognitive */
  remember: "Recall facts, terms, or basic concepts.",
  understand: "Explain ideas or concepts in your own words.",
  apply: "Use knowledge in new but familiar situations.",
  analyze: "Break information into parts and examine relationships.",
  evaluate: "Make judgments based on criteria or standards.",
  create: "Produce new or original work by combining elements.",

  /* Affective */
  receiving: "Willingness to attend to or be aware of stimuli.",
  responding: "Active participation by responding or reacting.",
  valuing: "Demonstrating commitment or belief in a value.",
  organization: "Integrating values into a consistent value system.",
  characterization: "Acting consistently according to internalised values.",

  /* Psychomotor */
  perception: "Use sensory cues to guide motor activity.",
  set: "Demonstrate readiness to perform a skill.",
  "guided response": "Perform skill under guidance or imitation.",
  mechanism: "Carry out skill with confidence and proficiency.",
  "complex overt response": "Perform complex skills smoothly and accurately.",
  adaptation: "Modify learned skills to suit new situations.",
  origination: "Create new movement patterns or procedures."
};

    /* =========================
   BLOOM RECOMMENDATION BY LEVEL
   (Cognitive, Affective, Psychomotor)
========================= */
const BLOOM_RECOMMENDATION_BY_LEVEL = {
  Diploma: {
    cognitive: ["Remember", "Understand", "Apply"],
    affective: ["Receiving", "Responding"],
    psychomotor: ["Perception", "Set", "Guided Response"],
    caution: ["Evaluate", "Create", "Adaptation", "Origination"]
  },

  Degree: {
    cognitive: ["Understand", "Apply", "Analyze"],
    affective: ["Responding", "Valuing"],
    psychomotor: ["Guided Response", "Mechanism"],
    caution: ["Remember", "Create", "Origination"]
  },

  Master: {
    cognitive: ["Analyze", "Evaluate", "Create"],
    affective: ["Valuing", "Organization"],
    psychomotor: ["Mechanism", "Complex Overt Response", "Adaptation"],
    caution: ["Remember", "Understand"]
  },

  PhD: {
    cognitive: ["Create"],
    affective: ["Characterization"],
    psychomotor: ["Adaptation", "Origination"],
    caution: ["Remember", "Understand", "Apply"]
  }
};

    
/* =========================
   ASSESSMENT & EVIDENCE
========================= */
const ASSESSMENT_MAP = {
  remember: {
    assessments: ["MCQ","True/False","Matching","Short-answer","Online quiz"],
    evidence: ["Exam paper","Answer key","LMS report"]
  },
  understand: {
    assessments: ["Short essay","Concept map","Oral questioning","Viva"],
    evidence: ["Essay script","Rubric","Viva sheet"]
  },
  apply: {
    assessments: ["Problem-solving","Simulation","Practical task","Short case"],
    evidence: ["Lab report","Checklist","Assessor notes"]
  },
  analyze: {
    assessments: ["Case study","Long case","Data analysis"],
    evidence: ["Analytical report","Annotated script"]
  },
  evaluate: {
    assessments: ["Critical review","Debate","Viva"],
    evidence: ["Review paper","Peer evaluation","Reflection"]
  },
  create: {
    assessments: ["Project","Capstone","Research proposal"],
    evidence: ["Project report","Prototype","Supervisor feedback"]
  },

  /* Affective */

  /* Affective (legacy support) */
receive: {
  assessments: ["Observation","Attendance-based task"],
  evidence: ["Observation checklist","Attendance record"]
},
respond: {
  assessments: ["Class participation","Reflective journal","Forum discussion"],
  evidence: ["Participation rubric","Reflection log"]
},
value: {
  assessments: ["Reflective essay","Ethics case reflection"],
  evidence: ["Reflection essay","Rubric","Assessor comments"]
},
  receiving: {
    assessments: ["Observation","Attendance-based task"],
    evidence: ["Observation checklist","Attendance record"]
  },
  responding: {
    assessments: ["Class participation","Reflective journal","Forum discussion"],
    evidence: ["Participation rubric","Reflection log"]
  },
  valuing: {
    assessments: ["Reflective essay","Ethics case reflection"],
    evidence: ["Reflection essay","Rubric","Assessor comments"]
  },
  organization: {
    assessments: ["Portfolio","Ethical reasoning task"],
    evidence: ["Portfolio artefact","Evaluation rubric"]
  },
  characterization: {
    assessments: ["Professional behaviour assessment","WBA"],
    evidence: ["Supervisor evaluation","Professional logbook"]
  },

  /* Psychomotor */
  perception: {
    assessments: ["Skill observation"],
    evidence: ["Observation checklist"]
  },
  set: {
    assessments: ["Equipment setup","Readiness check"],
    evidence: ["Setup checklist"]
  },
  "guided response": {
    assessments: ["Supervised practice","OSPE"],
    evidence: ["Skills checklist"]
  },
  mechanism: {
    assessments: ["OSCE","Practical exam"],
    evidence: ["Scoring rubric","Examiner sheet"]
  },
  "complex overt response": {
    assessments: ["Integrated task","Long case","Short case"],
    evidence: ["Performance rubric","Video evidence"]
  },
  adaptation: {
    assessments: ["Adaptive scenario"],
    evidence: ["Assessor report"]
  },
  origination: {
    assessments: ["Innovation project"],
    evidence: ["Project artefact","Evaluation rubric"]
  }
};

    function renderAssessmentFromBloom(key) {
  const ae = ASSESSMENT_MAP[key];
  if (!ae) return;

  assessList.innerHTML =
    "<ul>" +
    ae.assessments.map(a => `<li>${a}</li>`).join("") +
    "</ul>";

  evidenceList.innerHTML =
    "<ul>" +
    ae.evidence.map(e => `<li>${e}</li>`).join("") +
    "</ul>";
}
  

/* =========================
   NORMALISE BLOOM
========================= */
function normaliseBloomKey(value) {
  if (!value) return "";

  const v = value
    .toLowerCase()
    .replace(/\(.*?\)/g, "")   // buang (affective)
    .replace(/\s+/g, " ")
    .trim();

  // Affective
  if (v.includes("receiving") || v === "receive") return "receiving";
  if (v.includes("responding") || v === "respond") return "responding";
  if (v.includes("valuing") || v === "value") return "valuing";
  if (v.includes("organization") || v.includes("organisation")) return "organization";
  if (v.includes("characterization")) return "characterization";

  // Cognitive
  if (v.includes("remember")) return "remember";
  if (v.includes("understand")) return "understand";
  if (v.includes("apply")) return "apply";
  if (v.includes("analyze") || v.includes("analyse")) return "analyze";
  if (v.includes("evaluate")) return "evaluate";
  if (v.includes("create")) return "create";

  // Psychomotor
  if (v.includes("perception")) return "perception";
  if (v === "set") return "set";
  if (v.includes("guided")) return "guided response";
  if (v.includes("mechanism")) return "mechanism";
  if (v.includes("complex")) return "complex overt response";
  if (v.includes("adaptation")) return "adaptation";
  if (v.includes("origination")) return "origination";

  return "";
}

/* =========================
   THEME TOGGLE
========================= */
darkToggle.addEventListener('click', () => {
  const curr = document.body.getAttribute('data-theme') || 'light';
  const next = curr === 'light' ? 'dark' : 'light';

  document.body.setAttribute('data-theme', next);

  darkToggle.innerHTML =
    next === 'dark'
      ? '<i class="bi bi-sun"></i>'
      : '<i class="bi bi-moon"></i>';
});
    
/* =========================
   LOAD MAPPING
========================= */
async function loadMapping() {
  const res = await fetch('/api/mapping');
  MAP = await res.json();

  
  ploSel.innerHTML = '<option value="">Select PLO</option>';
}

function renderBloomGuidance(level) {
  const el = document.getElementById("bloom_level_guidance");
  if (!el) return;

  const MAP = {
    Diploma: `
üü¢ <strong>Preferred:</strong> Remember, Understand, Apply<br>
üü† <strong>Acceptable:</strong> Receiving, Responding; Perception, Set, Guided Response<br>
üî¥ <strong>Use sparingly:</strong> Analyze, Evaluate, Create
`,
    Degree: `
üü¢ <strong>Preferred:</strong> Apply, Analyze<br>
üü† <strong>Acceptable:</strong> Responding, Valuing; Guided Response, Mechanism<br>
üî¥ <strong>Use sparingly:</strong> Remember, Understand
`,
    Master: `
üü¢ <strong>Preferred:</strong> Analyze, Evaluate, Create; Valuing, Organization<br>
üü† <strong>Acceptable:</strong> Mechanism, Adaptation<br>
üî¥ <strong>Use sparingly:</strong> Remember, Understand, Apply
`,
    PhD: `
üü¢ <strong>Preferred:</strong> Create; Characterization; Adaptation, Origination<br>
üî¥ <strong>Use sparingly:</strong> Remember, Understand, Apply, Analyze
`
  };

  el.innerHTML = `
<strong>${level}-level Bloom guidance:</strong><br>
${MAP[level] || "Select a programme level to see guidance."}
`;
}


    function updateBloomTag(bloomKey){
  const tag = document.getElementById("bloomTag");
  if(!tag || !bloomKey) return;

  // Cognitive
  if (["remember","understand","apply","analyze","evaluate","create"].includes(bloomKey)){
    const map = {remember:"C1",understand:"C2",apply:"C3",analyze:"C4",evaluate:"C5",create:"C6"};
    tag.textContent = map[bloomKey];
    return;
  }

  // Affective
  if (["receiving","responding","valuing","organization","characterization"].includes(bloomKey)){
    const map = {receiving:"A1",responding:"A2",valuing:"A3",organization:"A4",characterization:"A5"};
    tag.textContent = map[bloomKey];
    return;
  }

  // Psychomotor
  if (["perception","set","guided response","mechanism","complex overt response","adaptation","origination"].includes(bloomKey)){
    const map = {
      perception:"P1",set:"P2","guided response":"P3",
      mechanism:"P4","complex overt response":"P5",
      adaptation:"P6",origination:"P7"
    };
    tag.textContent = map[bloomKey];
    return;
  }

  tag.textContent = "‚Äî";
}

 


function renderContentSuggestions(domain) {
  const box = contentSuggestionsRight;
  if (!box) return;

  const MAP = {
    cognitive: [
      "clinical concepts",
      "research data analysis",
      "case-based reasoning",
      "theoretical models",
      "evidence-based guidelines"
    ],
    affective: [
      "professional ethics",
      "patient-centred values",
      "interprofessional collaboration",
      "professional responsibility",
      "reflective practice"
    ],
    psychomotor: [
      "laboratory procedures",
      "clinical skill performance",
      "diagnostic testing protocols",
      "equipment handling techniques",
      "professional practice simulations"
    ]
  };

  const list = MAP[domain] || [];
  box.innerHTML = list.length
    ? `<ul class="muted">${list.map(i => `<li>${i}</li>`).join("")}</ul>`
    : `<span class="muted">No suggestions available.</span>`;
}
    
/* =========================
   BLOOM CHANGE (ONLY ONE)
========================= */
bloomSel.addEventListener("change", async () => {
  const raw = bloomSel.value;
  const key = normaliseBloomKey(raw);
  const plo = ploSel.value;

  updateBloomTag(key); 

  console.log("BLOOM:", raw, "‚Üí", key);

   /* Description */
  bloomDescEl.textContent =
    BLOOM_DESC[key] || "Select a Bloom level to see its description.";



// Assessment will be shown ONLY when user opens Assessment tab
// No auto-render, no auto-tab switching
  
  /* Backend verbs + meta */
  if (!plo || !key) return;

  const vres = await fetch(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(key)}?profile=${encodeURIComponent(profileSel.value)}`);
  const verbs = await vres.json();
  verbSel.innerHTML = '<option value="">Select Verb</option>';
  (verbs || []).forEach(v => verbSel.add(new Option(v, v)));


});

/* =========================
   STEP 1 ‚Äî IEG ‚Üí PEO (CLEAN, FINAL)
========================= */

/* ---------- Generate PEO ---------- */
function generatePEOFromProgramme(programmeName, level){
  if (!programmeName || !level) return [];

  const vbe = VBE_BY_LEVEL[level]?.values || [];

  return [
    {
      code: "PEO1",
      text: `Graduates of the ${programmeName} demonstrate strong disciplinary knowledge and professional competence guided by ${vbe[0] || "professional values"}.`,
      rationale: "This PEO emphasises mastery of disciplinary knowledge and professional competence."
    },
    {
      code: "PEO2",
      text: `Graduates of the ${programmeName} communicate and collaborate effectively with diverse stakeholders guided by ${vbe[1] || "ethical principles"}.`,
      rationale: "This PEO focuses on communication skills and teamwork in professional contexts."
    },
    {
      code: "PEO3",
      text: `Graduates of the ${programmeName} demonstrate leadership, autonomy and commitment to lifelong learning.`,
      rationale: "This PEO supports leadership development and continuous professional growth."
    },
    {
      code: "PEO4",
      text: `Graduates of the ${programmeName} apply innovation and entrepreneurial thinking where appropriate.`,
      rationale: "This PEO encourages innovation, creativity and value creation."
    },
    {
      code: "PEO5",
      text: `Graduates of the ${programmeName} uphold ethics, professionalism and social responsibility.`,
      rationale: "This PEO ensures ethical conduct and professional integrity."
    }
  ];
}

/* =========================
   STEP 1 + STEP 2 + BLOOM CONTROLLER (FINAL & STABLE)
========================= */
document.addEventListener("DOMContentLoaded", () => {

  /* ========= INIT ========= */
  loadMapping();

  // show Bloom guidance if level already selected (browser restore)
  if (levelSel.value) {
    renderBloomGuidance(levelSel.value);
  }

  /* ========= PROGRAMME LEVEL ========= */
  levelSel.addEventListener("change", () => {
    renderBloomGuidance(levelSel.value);
  });

  /* ========= IEG INPUT ========= */
  const iegInput = document.getElementById("ieg_input");
  if (iegInput) {
    iegInput.addEventListener("input", e => {
      IEG_TEXT = e.target.value.trim();
    });
  }

  /* ========= COURSE NAME ========= */
  const courseInput = document.getElementById("courseName");
  if (courseInput) {
    courseInput.addEventListener("input", e => {
      COURSE_NAME = e.target.value.trim();
    });
  }

  /* ========= STEP 1: GENERATE PEO ========= */
  const generateBtnPEO = document.getElementById("generatePEO");

  generateBtnPEO.addEventListener("click", () => {

    const programmeName = document.getElementById("programmeName").value.trim();
    const level = levelSel.value;

    if (!programmeName || !level) {
      alert("Please enter Programme Name and Programme Level");
      return;
    }

    const peos = generatePEOFromProgramme(programmeName, level);

    peoSuggestions.innerHTML = "";
    peos.forEach(p => {
      const mappedPLOs = PEO_PLO_MAP[p.code] || [];
      peoSuggestions.innerHTML += `
        <div class="logic-box mb-2">
          <strong>${p.code}</strong><br>
          ${p.text}
          <div class="mt-2 muted" style="font-size:0.85rem">
            <strong>Mapped PLOs:</strong> ${mappedPLOs.join(", ")}
          </div>
        </div>`;
    });

    peoSelect.innerHTML = '<option value="">Select PEO</option>';
    peos.forEach(p => peoSelect.add(new Option(p.code, p.code)));
    peoSelect.dataset.map = JSON.stringify(peos);

    iegLogicBox.classList.add("d-none");
    ploSel.innerHTML = '<option value="">Select PLO</option>';
    peoPloLogicBox.textContent = "‚Äî";
  });

  /* ========= STEP 1: SELECT PEO ========= */
  peoSelect.addEventListener("change", async () => {

    const peo = peoSelect.value;
    ploSel.innerHTML = '<option value="">Select PLO</option>';
    peoPloLogicBox.textContent = "‚Äî";

    if (!peo) {
      iegLogicBox.classList.add("d-none");
      return;
    }

    const peos = JSON.parse(peoSelect.dataset.map || "[]");
    const selected = peos.find(p => p.code === peo);
    const peoData = PROGRAMME_PEO_MAP[peo];
    const mappedPLOs = PEO_PLO_MAP[peo] || [];

    if (selected && peoData) {
      iegLogicBox.classList.remove("d-none");
      iegLogicBox.innerHTML = `
        <strong>${peo} ‚Äì Programme Educational Objective</strong><br>
        ${selected.rationale}

        <div class="mt-3">
          <strong>PEO Indicators:</strong>
          <ul>
            ${peoData.indicators.map(i => `<li>${i}</li>`).join("")}
          </ul>
        </div>

        <div class="mt-2 muted" style="font-size:0.85rem">
          <strong>Data sources:</strong> ${peoData.dataSource.join(", ")}<br>
          <strong>Review cycle:</strong> 3‚Äì5 years after graduation
        </div>

        <div class="mt-2">
          <strong>Operationalised through PLOs:</strong> ${mappedPLOs.join(", ")}
        </div>
      `;
    }

    try {
      const res = await fetch(`/api/get_plos/${encodeURIComponent(peo)}`);
      const plos = await res.json();
      (plos || []).forEach(p => ploSel.add(new Option(p, p)));

      peoPloLogicBox.textContent =
        "This PLO operationalises the competencies described in the selected PEO.";

    } catch (err) {
      console.error("PEO ‚Üí PLO error", err);
    }
  });

  /* ========= STEP 2: SELECT PLO ========= */
  ploSel.addEventListener("change", async () => {
    
    if (!profileSel.value) {
  alert("Please select Discipline first.");
  return;
}

    const plo = ploSel.value;
  if (!plo) return;


    const programmeName =
      document.getElementById("programmeName").value || "the programme";

    // reset
    ploStatementEl.textContent = "‚Äî";
    ploIndicatorEl.textContent = "‚Äî";
    peoPloLogicBox.textContent = "‚Äî";

    bloomSel.innerHTML = '<option value="">Select Bloom</option>';
    verbSel.innerHTML = '<option value="">Select Verb</option>';
    bloomDescEl.textContent = "Select a Bloom level to see its description.";
    assessList.innerHTML = "‚Äî";
    evidenceList.innerHTML = "‚Äî";


    if (UNIVERSAL_PLO_MAP[plo]) {
      const p = UNIVERSAL_PLO_MAP[plo];

      ploStatementEl.textContent = p.statement(programmeName);
      ploIndicatorEl.innerHTML =
        "<ul>" + p.indicator.map(i => `<li>${i}</li>`).join("") + "</ul>";

      peoPloLogicBox.innerHTML = `
        <strong>Programme Learning Outcome Alignment</strong><br>
        This Programme Learning Outcome addresses the
        <em>${p.domain}</em> domain and is underpinned by
        <strong>${p.vbe}</strong> as its Value-Based Education (VBE) indicator.
      `;
    }

    try {
      const res = await fetch(
        `/api/get_blooms/${encodeURIComponent(plo)}?profile=${encodeURIComponent(profileSel.value)}`
      );
      const blooms = await res.json();

      (blooms || []).forEach(b =>
        bloomSel.add(new Option(b, b))
      );

      if (blooms && blooms.length > 0) {
        bloomSel.value = blooms[0];
        bloomSel.dispatchEvent(new Event("change", { bubbles: true }));
      }

    } catch (err) {
      console.error("PLO ‚Üí Bloom error", err);
    }
  });

  /* ========= LOG PEO‚ÄìPLO CHECK (ONCE ONLY) ========= */
  ploSel.addEventListener("change", () =>
    logEvent("peo_plo_check", { 
      peo: peoSelect.value || null,
      plo: ploSel.value
    })
  );

  /* ========= TAB LOGGING ========= */
  document.querySelectorAll("#tabNav .nav-link").forEach(tab => {
    tab.addEventListener("click", () =>
      logEvent("tab_click", { tab: tab.textContent.trim() })
    );
  });

});

    /* Generate CLO */
    generateBtn.addEventListener('click', async () => {
      if (!ploSel.value || !bloomSel.value || !verbSel.value || !contentInput.value.trim()) {
        alert('Please fill PLO, Bloom, Verb and Content.');
        return;
      }
      busyEl.style.display = 'inline';
      generateBtn.disabled = true;

      const fd = new FormData();
      // ===== CAPTURE PEO STATEMENT =====
const peoStatementText =
  iegLogicBox?.innerText
    ?.replace(/\s+/g, " ")
    ?.trim() || "";

// ===== CAPTURE PLO INDICATOR =====
const ploIndicatorText =
  ploIndicatorEl?.innerText
    ?.replace(/\s+/g, " ")
    ?.trim() || "";

fd.append("peo_statement", peoStatementText);
fd.append("plo_indicator", ploIndicatorText);
      fd.append('profile', profileSel.value);
      fd.append('level', levelSel.value);
      fd.append('plo', ploSel.value);
      fd.append('bloom', bloomSel.value);
      fd.append('verb', verbSel.value);
      fd.append('content', contentInput.value);
      fd.append("ieg", IEG_TEXT);
      fd.append("courseName", COURSE_NAME);
      fd.append("programmeName", document.getElementById("programmeName").value);

      logEvent('generate_clo_attempt', { plo: ploSel.value, bloom: bloomSel.value, verb: verbSel.value });

      try {
        const res = await fetch('/generate', { method:'POST', body: fd });
        if (!res.ok) { const err = await res.text().catch(()=> 'server error'); throw new Error(err); }
        const data = await res.json();
        LAST_CLO = data;

        cloText.innerText = data.clo || '';
        cloCard.style.display = 'block';

        variantsPanel.innerHTML = '';
        const opts = data.variants || data.clo_options || {};
        Object.entries(opts).forEach(([label, text]) => {
          const div = document.createElement('div');
          div.className = 'logic-box mb-2';
          div.style.cursor = 'pointer';
          div.innerHTML = `<strong>${label}</strong><div class="mt-1">${text}</div>`;
          div.onclick = () => cloText.innerText = text;
          variantsPanel.appendChild(div);
        });

        variants_list.innerHTML = '';
        Object.entries(opts).forEach(([label, text]) => {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${label}:</strong> ${text}`;
          variants_list.appendChild(p);
        });

       const key = normaliseBloomKey(bloomSel.value);

// üî• Backend boleh override assessment
if (Array.isArray(data.assessments) && data.assessments.length) {
  assessList.innerHTML =
    '<ul>' + data.assessments.map(a => `<li>${a}</li>`).join('') + '</ul>';
}

// üî• Backend override evidence JIKA ADA
if (data.evidence && Object.keys(data.evidence).length) {
  evidenceList.innerHTML =
    Object.entries(data.evidence)
      .map(([k,v]) => `<div><strong>${k}</strong>: ${v.join('; ')}</div>`)
      .join('');
}

        else {
  // ‚úÖ FALLBACK ‚Äî affective & others
  renderAssessmentFromBloom(key);
}


        
// ‚ùå JANGAN letak else ‚Üí biar evidence dari ASSESSMENT_MAP
        

        logEvent('generate_clo', { plo: ploSel.value, bloom: bloomSel.value, verb: verbSel.value });

      } catch (e) {
        console.error(e);
        alert('Error generating CLO. See console for details.');
        logEvent('generate_clo_error', { error: (e.message || String(e)) });
      } finally {
        busyEl.style.display = 'none';
        generateBtn.disabled = false;
      }
      
      console.log({
      plo: ploSel.value,
      bloom: bloomSel.value,
      verb: verbSel.value,
      });

  });
      



    /* Copy CLO */
    copyBtn.addEventListener('click', async () => {
      if (!cloText.innerText) return;
      try {
        await navigator.clipboard.writeText(cloText.innerText);
        copyBtn.innerText = 'Copied';
        setTimeout(()=> copyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i> Copy', 1200);
        logEvent('copy_clo', { plo: ploSel.value || null });
      } catch(e) { alert('Copy failed'); }
    });



    /* =========================
   DOWNLOAD CLO (GET MODE)
========================= */
downloadBtn.addEventListener('click', () => {
  if (!cloText.innerText.trim()) {
    alert("Please generate a CLO before downloading.");
    return;
  }

  logEvent('download_clo', { plo: ploSel.value || null });

  // Backend-controlled download
  window.location = '/download';
});

    downloadRubricBtn.addEventListener('click', () => {
      logEvent('download_rubric', { plo: ploSel.value || null });
      window.location = '/download_rubric';
    });

    /* Toggle variants */
    toggleVariantsBtn.addEventListener('click', () => {
      const hidden = variantsPanel.style.display === 'none' || variantsPanel.style.display === '';
      variantsPanel.style.display = hidden ? 'block' : 'none';
      toggleVariantsBtn.innerText = hidden ? 'Hide variants' : 'Show variants';
      logEvent('variants_toggle', { visible: hidden });
    });

// tab click events
document.querySelectorAll('#tabNav .nav-link').forEach(tab => {
  tab.addEventListener('click', () => {
    logEvent('tab_click', { tab: tab.textContent.trim() });
  });
});


  </script>
</body>
</html>
