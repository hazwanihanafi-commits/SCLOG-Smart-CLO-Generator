<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SCLOG — Smart CLO Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
body{background:#f5f3ff;font-family:system-ui}
.card-box{background:#fff;border-radius:14px;padding:16px;border:1px solid #e5e7eb}
.step-header{font-weight:800;color:#4c1d95}
.step-desc{font-size:.9rem;color:#6b7280}
.logic-box{background:#f7f2ff;border-radius:10px;padding:10px}
.bloom-tag{font-size:.7rem;font-weight:900;background:#ede9fe;color:#6d28d9;padding:4px 8px;border-radius:999px}
</style>
</head>

<body>
<div class="container my-4">

<!-- HEADER -->
<div class="card-box mb-3 d-flex justify-content-between">
  <div>
    <h3 style="color:#6d28d9;font-weight:900">SCLOG</h3>
    <div class="text-muted">Smart Course Learning Outcome Generator</div>
  </div>
</div>

<!-- MODE TABS -->
<ul class="nav nav-tabs mb-3" id="modeTabs">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab"
      data-bs-target="#mode-programme" data-mode="programme">
      Programme Design
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab"
      data-bs-target="#mode-refine" data-mode="refine">
      Refine Programme
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab"
      data-bs-target="#mode-plo" data-mode="plo_only">
      PLO Only
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab"
      data-bs-target="#mode-clo" data-mode="clo_only">
      CLO Only
    </button>
  </li>
</ul>

<div class="tab-content">

<!-- MODE 1 -->
<div class="tab-pane fade show active" id="mode-programme">
  <div class="card-box mb-3">
    <div class="step-header">Programme Design</div>
    <div class="step-desc">Design a new programme starting from IEG.</div>

    <label class="form-label mt-2">IEG</label>
    <select id="ieg_programme" class="form-select"></select>

    <label class="form-label mt-2">PEO</label>
    <select id="peo_programme" class="form-select"></select>

    <div class="mt-2">
      <div class="form-label">Why IEG → PEO?</div>
      <div id="ieg_peo_logic_programme" class="logic-box">—</div>
    </div>

    <label class="form-label mt-3">PLO</label>
    <select id="plo_programme" class="form-select"></select>
  </div>
</div>

<!-- MODE 2 -->
<div class="tab-pane fade" id="mode-refine">
  <div class="card-box mb-3">
    <div class="step-header">Refine Programme</div>
    <div class="step-desc">Refine existing PEO, PLO, and CLO.</div>

    <label class="form-label mt-2">PEO</label>
    <select id="peo_refine" class="form-select"></select>

    <label class="form-label mt-3">PLO</label>
    <select id="plo_refine" class="form-select"></select>

    <div class="mt-2">
      <div class="form-label">Why PEO → PLO?</div>
      <div id="peo_plo_logic_refine" class="logic-box">—</div>
    </div>
  </div>
</div>

<!-- MODE 3 -->
<div class="tab-pane fade" id="mode-plo">
  <div class="card-box mb-3">
    <div class="step-header">PLO Only</div>
    <div class="step-desc">Select a PLO to generate CLOs.</div>

    <label class="form-label mt-2">PLO</label>
    <select id="plo_only" class="form-select"></select>
  </div>
</div>

<!-- MODE 4 -->
<div class="tab-pane fade" id="mode-clo">
  <div class="card-box mb-3">
    <div class="step-header">CLO Only</div>
    <div class="step-desc">
      Generate CLO without programme context (Bloom + Verb + Content).
    </div>
  </div>
</div>

</div>

<!-- CLO BUILDER -->
<div class="card-box mt-4">
  <div class="d-flex align-items-center gap-2">
    <h5 class="mb-0">Smart CLO Builder</h5>
    <span id="bloomTag" class="bloom-tag">—</span>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-4">
      <label class="form-label">Bloom</label>
      <select id="bloom" class="form-select"></select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Verb</label>
      <select id="verb" class="form-select"></select>
    </div>

    <div class="col-md-4">
      <label class="form-label">Content</label>
      <input id="content" class="form-control"
        placeholder="e.g. ECG waveform interpretation">
    </div>

    <div class="col-12">
      <button id="generateBtn" class="btn btn-primary">
        Generate CLO
      </button>
    </div>

    <div id="cloCard" class="col-12 mt-3" style="display:none">
      <div class="logic-box">
        <strong>CLO:</strong>
        <div id="clo_text"></div>
      </div>
    </div>
  </div>
</div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
let CURRENT_MODE = "programme";
const $ = id => document.getElementById(id);

/* ===== MODE CHANGE (BOOTSTRAP SAFE) ===== */
document.querySelectorAll('#modeTabs button').forEach(btn=>{
  btn.addEventListener('shown.bs.tab', e=>{
    CURRENT_MODE = e.target.dataset.mode;
  });
});

/* ===== LOAD INITIAL DATA ===== */
async function loadMapping(){
  const res = await fetch('/api/mapping');
  const MAP = await res.json();
  fill($('ieg_programme'), MAP.IEGs);
  fill($('plo_only'), Object.keys(MAP.PLOIndicators || {}));
}
loadMapping();

function fill(sel, list=[]){
  sel.innerHTML = '<option value="">Select</option>';
  list.forEach(v => sel.add(new Option(v,v)));
}

/* ===== PROGRAMME MODE ===== */
$('ieg_programme')?.addEventListener('change', async()=>{
  if(CURRENT_MODE!=='programme')return;
  const ieg=$('ieg_programme').value;
  fill($('peo_programme'),
    await fetch(`/api/get_peos/${ieg}`).then(r=>r.json())
  );
  $('ieg_peo_logic_programme').textContent =
    await fetch(`/api/logic/ieg_peo/${ieg}`).then(r=>r.text());
});

$('peo_programme')?.addEventListener('change', async()=>{
  fill($('plo_programme'),
    await fetch(`/api/get_plos/${$('peo_programme').value}`).then(r=>r.json())
  );
});

/* ===== REFINE MODE ===== */
$('peo_refine')?.addEventListener('change', async()=>{
  const peo=$('peo_refine').value;
  fill($('plo_refine'),
    await fetch(`/api/get_plos/${peo}`).then(r=>r.json())
  );
  $('peo_plo_logic_refine').textContent =
    await fetch(`/api/logic/peo_plo/${peo}`).then(r=>r.text());
});

/* ===== PLO → BLOOM ===== */
function hookPLO(sel){
  sel?.addEventListener('change', async()=>{
    if(!sel.value)return;
    fill($('bloom'),
      await fetch(`/api/get_blooms/${sel.value}`).then(r=>r.json())
    );
  });
}
hookPLO($('plo_programme'));
hookPLO($('plo_refine'));
hookPLO($('plo_only'));

/* ===== BLOOM → VERB ===== */
$('bloom').addEventListener('change', async()=>{
  if(CURRENT_MODE === 'clo_only'){
    fill($('verb'), [
      "describe","explain","apply",
      "analyze","evaluate","design","demonstrate"
    ]);
    return;
  }
  const plo =
    $('plo_programme').value ||
    $('plo_refine').value ||
    $('plo_only').value;

  if(!plo)return;

  fill($('verb'),
    await fetch(`/api/get_verbs/${plo}/${$('bloom').value}`).then(r=>r.json())
  );
});

/* ===== GENERATE CLO ===== */
$('generateBtn').addEventListener('click', async()=>{
  const fd = new FormData();
  fd.append("mode", CURRENT_MODE);
  fd.append("plo",
    $('plo_programme').value ||
    $('plo_refine').value ||
    $('plo_only').value || ""
  );
  fd.append("bloom", $('bloom').value);
  fd.append("verb", $('verb').value);
  fd.append("content", $('content').value);

  const data = await fetch('/generate',{method:'POST',body:fd})
    .then(r=>r.json());

  $('clo_text').textContent = data.clo;
  $('cloCard').style.display = 'block';
});
</script>
</body>
</html>
