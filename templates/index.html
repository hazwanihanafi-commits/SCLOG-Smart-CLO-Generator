<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCLOG â€” Smart Course Learning Outcome Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- THEME -->
  <style>
    :root{
      --primary:#7c3aed;
      --primary-soft:#ede9fe;
      --card:#ffffff;
      --muted:#6b7280;
      --border:#e5e7eb;
      --radius:16px;
      --shadow:0 10px 28px rgba(0,0,0,.06);
    }

    body{
      background:linear-gradient(180deg,#f5f3ff,#faf9ff);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;
      color:#2a2344;
    }

    .container-app{max-width:900px;margin:auto;padding:20px}
    .card-box{
      background:var(--card);
      border-radius:var(--radius);
      padding:22px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      margin-bottom:18px;
    }

    .main-header{
      background:linear-gradient(135deg,#7c3aed,#a78bfa);
      color:#fff;
    }

    .step-pill{
      background:var(--primary-soft);
      color:var(--primary);
      font-weight:800;
      font-size:.65rem;
      padding:4px 10px;
      border-radius:999px;
    }

    .step-header{
      font-weight:800;
      color:var(--primary);
      font-size:1.05rem;
    }

    .step-desc{color:var(--muted);font-size:.9rem}

    .logic-box{
      background:#f7f2ff;
      border-radius:12px;
      padding:12px;
      font-size:.9rem;
    }

    .form-control,.form-select{
      border-radius:12px;
      background:#fafaff;
      color:#111827;
    }

    .bloom-tag{
      background:var(--primary-soft);
      color:var(--primary);
      font-weight:800;
      font-size:.7rem;
      padding:4px 8px;
      border-radius:999px;
    }

    footer{
      text-align:center;
      font-size:.8rem;
      color:var(--muted);
      margin-top:30px;
    }
  </style>
</head>

<body>

<div class="container-app">

  <!-- HEADER -->
  <div class="card-box main-header mb-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-0"><i class="bi bi-stars me-2"></i>SCLOG</h4>
        <div style="opacity:.9;font-size:.9rem">
          Smart Course Learning Outcome Generator
        </div>
      </div>
      <button id="darkToggle" class="btn btn-outline-light btn-sm">
        <i class="bi bi-moon"></i>
      </button>
    </div>
  </div>

  <!-- STEP 1 -->
  <div id="step1-programme" class="card-box">
    <div class="d-flex gap-2 mb-2">
      <span class="step-pill">STEP 1</span>
      <div class="step-header">Programme Context</div>
    </div>

    <div class="step-desc mb-3">
      Define programme context and generate Programme Educational Objectives (PEO).
    </div>

    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Discipline</label>
        <select id="profile" class="form-select">
          <option value="">Select discipline</option>
          <option value="health">Medical & Health</option>
          <option value="sc">Computer Science</option>
          <option value="eng">Engineering</option>
          <option value="edu">Education</option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Programme Level</label>
        <select id="level" class="form-select">
          <option value="">Select level</option>
          <option>Diploma</option>
          <option>Degree</option>
          <option>Master</option>
          <option>PhD</option>
        </select>
      </div>

      <div class="col-md-5">
        <label class="form-label">Programme Name</label>
        <input id="programmeName" class="form-control" placeholder="e.g. Master of Clinical Exercise Science">
      </div>

      <div class="col-12">
        <label class="form-label">Institutional Educational Goals (IEG)</label>
        <textarea id="ieg_input" class="form-control" rows="3"></textarea>
      </div>

      <div class="col-12">
        <button id="generatePEO" class="btn btn-outline-primary">
          Suggest Programme Educational Objectives (PEOs)
        </button>
      </div>

      <div id="peoSuggestions" class="col-12"></div>

      <div class="col-md-6">
        <label class="form-label mt-3">Select PEO</label>
        <select id="peoSelect" class="form-select"></select>
      </div>

      <div id="ieg_peo_logic" class="logic-box d-none col-12"></div>
    </div>
  </div>

  <!-- STEP 2 -->
  <div id="step2-plo" class="card-box">
    <div class="d-flex gap-2 mb-2">
      <span class="step-pill">STEP 2</span>
      <div class="step-header">Programme Learning Outcomes (PLO)</div>
    </div>

    <label class="form-label">PLO for selected PEO</label>
    <select id="plo" class="form-select mb-3"></select>

    <div id="peo_plo_logic" class="logic-box mb-3">â€”</div>

    <div>
      <strong>PLO Statement</strong>
      <div id="plo_statement" class="mt-1"></div>
    </div>

    <div class="mt-2">
      <strong>PLO Indicator</strong>
      <div id="plo_indicator"></div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div id="step3-clo" class="card-box">
    <div class="d-flex gap-2 mb-2">
      <span class="step-pill">STEP 3</span>
      <div class="step-header">Course Learning Outcome (CLO)</div>
      <span id="bloomTag" class="bloom-tag">â€”</span>
    </div>

    <div class="step-desc mb-3">
      Construct a measurable CLO using Bloomâ€™s Taxonomy.
    </div>

    <label class="form-label">Bloom</label>
    <select id="bloom" class="form-select mb-2"></select>
    <div id="bloom_desc" class="text-muted mb-3"></div>

    <label class="form-label">Verb</label>
    <select id="verb" class="form-select mb-3"></select>

    <label class="form-label">Course Name</label>
    <input id="courseName" class="form-control mb-3">

    <label class="form-label">Content (learning focus)</label>
    <input id="content" class="form-control mb-3">

    <div class="d-flex gap-2">
      <button id="generateBtn" class="btn btn-primary">
        <i class="bi bi-magic me-1"></i> Generate CLO
      </button>
      <button id="copyBtn" class="btn btn-outline-secondary">
        Copy
      </button>
      <span id="busy" class="text-muted" style="display:none">Generatingâ€¦</span>
    </div>

    <div id="cloCard" class="card-box mt-4" style="display:none">
      <strong>Generated CLO</strong>
      <div id="clo_text" class="mt-2"></div>
    </div>
  </div>

  <footer>
    Â© 2025 â€¢ Assoc Prof Dr Hazwani Ahmad Yusof @ Hanafi â€” Universiti Sains Malaysia
  </footer>

</div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
 
<script>
document.addEventListener("DOMContentLoaded", () => {

  /* =========================
     HELPER
  ========================= */
  const $ = id => document.getElementById(id);

  /* =========================
     DOM
  ========================= */
  const modeSelector = $("modeSelector");
  const startBtn = $("startBtn");
  const backBtn = $("backBtn");

  const step1 = $("step1");
  const step2 = $("step2");
  const step3 = $("step3");

  const profileSel = $("profile");
  const levelSel = $("level");
  const programmeSel = $("programmeName");
  const iegInput = $("ieg_input");

  const peoBtn = $("generatePEO");
  const peoSelect = $("peoSelect");
  const peoSuggestions = $("peoSuggestions");
  const iegLogicBox = $("ieg_peo_logic");

  const ploSel = $("plo");
  const peoPloLogicBox = $("peo_plo_logic");
  const ploStatementEl = $("plo_statement");
  const ploIndicatorEl = $("plo_indicator");


  const bloomSel = $("bloom");
  const bloomDescEl = $("bloom_desc");
  const bloomTag = $("bloomTag");
  const bloomGuidance = $("bloom_level_guidance");

  const verbSel = $("verb");
  const contentInput = $("content");

  const generateBtn = $("generateBtn");
  const busyEl = $("busy");
  const cloCard = $("cloCard");
  const cloText = $("clo_text");
  
  const peoSelect = document.getElementById("peoSelect");

  /* =========================
     INITIAL STATE
  ========================= */
  [step1, step2, step3].forEach(s => s.classList.add("hidden"));
  backBtn.classList.add("hidden");
  bloomSel.disabled = true;

  let IEG_TEXT = "";
  let COURSE_NAME = "";

  /* =========================
     MODE SELECTOR
  ========================= */
  startBtn.addEventListener("click", () => {
    const mode = document.querySelector('input[name="mode"]:checked')?.value;
    if (!mode) return;

    modeSelector.classList.add("hidden");
    backBtn.classList.remove("hidden");

    if (mode === "full") {
      step1.classList.remove("hidden");
      step2.classList.remove("hidden");
      step3.classList.remove("hidden");
    }

    if (mode === "programme") {
      step1.classList.remove("hidden");
      step2.classList.remove("hidden");
    }

    if (mode === "clo") {
      step3.classList.remove("hidden");
    }

    step1.scrollIntoView({ behavior: "smooth" });
  });

  backBtn.addEventListener("click", () => {
    [step1, step2, step3].forEach(s => s.classList.add("hidden"));
    modeSelector.classList.remove("hidden");
    backBtn.classList.add("hidden");
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  /* =========================
     IEG + COURSE
  ========================= */
  iegInput.addEventListener("input", e => IEG_TEXT = e.target.value.trim());
  $("courseName").addEventListener("input", e => COURSE_NAME = e.target.value.trim());

  /* =========================
     BLOOM GUIDANCE
  ========================= */
  levelSel.addEventListener("change", () => {
    bloomGuidance.innerHTML = `<strong>${levelSel.value}-level Bloom guidance</strong>`;
  });

  
 /* =========================
   STEP 1: GENERATE PEO (PATCHED)
========================= */
peoBtn.addEventListener("click", () => {

  const programme = programmeSel.value.trim();
  const level = levelSel.value;

  if (!programme || !level) {
    alert("Please enter Programme Name and Level");
    return;
  }

  const peos = generatePEOFromProgramme(programme, level);

  /* RESET UI */
  peoSuggestions.innerHTML = "";
  peoSelect.innerHTML = `<option value="">Select PEO</option>`;
  ploSel.innerHTML = `<option value="">Select PLO</option>`;
  iegLogicBox.classList.add("d-none");
  peoPloLogicBox.textContent = "â€”";

  /* STORE PEO DATA */
  peoSelect.dataset.map = JSON.stringify(peos);

  /* RENDER CLICKABLE PEO CARDS */
  peos.forEach(p => {

    const mappedPLOs = PEO_PLO_MAP[p.code] || [];

    const div = document.createElement("div");
    div.className = "logic-box mb-2 peo-card";
    div.style.cursor = "pointer";

    div.innerHTML = `
      <strong>${p.code}</strong><br>
      ${p.text}
      <div class="mt-2 muted" style="font-size:0.85rem">
        <strong>Mapped PLOs:</strong> ${mappedPLOs.join(", ")}
      </div>
    `;

    /* ðŸ”¥ CLICK PEO CARD = SELECT DROPDOWN */
    div.onclick = () => {
      peoSelect.value = p.code;
      peoSelect.dispatchEvent(new Event("change"));
    };

    peoSuggestions.appendChild(div);

    /* ALSO ADD TO DROPDOWN */
    peoSelect.add(new Option(p.code, p.code));
  });

  /* âœ… AUTO-SELECT FIRST PEO (IMPORTANT) */
  if (peos.length) {
    peoSelect.value = peos[0].code;
    peoSelect.dispatchEvent(new Event("change"));
  }
});


  /* =========================
     STEP 1: SELECT PEO
  ========================= */
  peoSelect.addEventListener("change", async () => {

  const peo = peoSelect.value;
  ploSel.innerHTML = '<option value="">Select PLO</option>';
  peoPloLogicBox.textContent = "â€”";

  if (!peo) {
    iegLogicBox.classList.add("d-none");
    return;
  }

  const peos = JSON.parse(peoSelect.dataset.map || "[]");
  const selected = peos.find(p => p.code === peo);
  const peoData = PROGRAMME_PEO_MAP[peo];
  const mappedPLOs = PEO_PLO_MAP[peo] || [];

  /* === SHOW PEO INDICATORS === */
  if (selected && peoData) {
    iegLogicBox.classList.remove("d-none");
    iegLogicBox.innerHTML = `
      <strong>${peo} â€“ Programme Educational Objective</strong><br>
      ${selected.rationale}

      <div class="mt-3">
        <strong>PEO Indicators:</strong>
        <ul>
          ${peoData.indicators.map(i => `<li>${i}</li>`).join("")}
        </ul>
      </div>

      <div class="mt-2 muted" style="font-size:0.85rem">
        <strong>Data sources:</strong> ${peoData.dataSource.join(", ")}<br>
        <strong>Review cycle:</strong> 3â€“5 years after graduation
      </div>

      <div class="mt-2">
        <strong>Operationalised through PLOs:</strong> ${mappedPLOs.join(", ")}
      </div>
    `;
  }

  /* === LOAD PLOs === */
  try {
    const res = await fetch(`/api/get_plos/${encodeURIComponent(peo)}`);
    const plos = await res.json();

    (plos || []).forEach(p =>
      ploSel.add(new Option(p, p))
    );

    peoPloLogicBox.innerHTML = `
      This Programme Learning Outcome (PLO) operationalises
      the competencies articulated in the selected PEO.
    `;

  } catch (err) {
    console.error("PEO â†’ PLO error", err);
  }
});


  /* =========================
     STEP 2: SELECT PLO
  ========================= */
  ploSel.addEventListener("change", async () => {
    const plo = ploSel.value;
    bloomSel.innerHTML = `<option value="">Select Bloom</option>`;
    bloomSel.disabled = true;
    if (!plo || !profileSel.value) return;

    const res = await fetch(`/api/get_blooms/${plo}?profile=${profileSel.value}`);
    const blooms = await res.json();
    blooms.forEach(b => bloomSel.add(new Option(b, b)));
    bloomSel.disabled = false;
  });

  /* =========================
     BLOOM â†’ VERB + DESC
  ========================= */
  bloomSel.addEventListener("change", async () => {
    const bloom = bloomSel.value;
    const key = normaliseBloomKey(bloom);
    bloomDescEl.textContent = BLOOM_DESC[key] || "";
    bloomTag.textContent = key.toUpperCase();

    verbSel.innerHTML = `<option value="">Select Verb</option>`;
    const res = await fetch(`/api/get_verbs/${ploSel.value}/${key}?profile=${profileSel.value}`);
    const verbs = await res.json();
    verbs.forEach(v => verbSel.add(new Option(v, v)));
  });

  /* =========================
     GENERATE CLO
  ========================= */
  generateBtn.addEventListener("click", async () => {
    if (!ploSel.value || !bloomSel.value || !verbSel.value || !contentInput.value.trim()) {
      alert("Please complete all fields");
      return;
    }

    busyEl.style.display = "inline";
    generateBtn.disabled = true;

    const fd = new FormData();
    fd.append("profile", profileSel.value);
    fd.append("level", levelSel.value);
    fd.append("plo", ploSel.value);
    fd.append("bloom", bloomSel.value);
    fd.append("verb", verbSel.value);
    fd.append("content", contentInput.value);
    fd.append("ieg", IEG_TEXT);
    fd.append("courseName", COURSE_NAME);
    fd.append("programmeName", programmeSel.value);

    const res = await fetch("/generate", { method: "POST", body: fd });
    const data = await res.json();

    cloText.innerText = data.clo;
    cloCard.style.display = "block";

    busyEl.style.display = "none";
    generateBtn.disabled = false;
  });

});
</script>


</body>
</html>
