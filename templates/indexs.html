<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCLOG — Smart CLO Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HMBYNXRLBE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HMBYNXRLBE', { 'send_page_view': true });

    function logEvent(name, data = {}) {
      if (typeof gtag === 'function') {
        try { gtag('event', name, data); } catch(e){ console.debug('gtag error', e); }
      } else {
        console.debug('GA not ready - event', name, data);
      }
    }
  </script>

  <!-- Theme CSS -->
  <style>
    :root{
      --usm-purple: #6d28d9;
      --usm-purple-2: #8b5cf6;
      --bg-light: #f5f3ff;
      --card: #ffffff;
      --muted: #6c6480;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(15,23,42,0.06);
    }

    html,body{height:100%;}
    body {
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: var(--bg-light);
      color: #2a2344;
      line-height:1.45;
    }
    body[data-theme="dark"] {
      background: linear-gradient(180deg,#11101a,#16081f);
      color: #efe6ff;
    }

    .container-app {
      max-width:1200px;
      margin:18px auto 40px;
      padding:12px;
    }

    .card-box {
      background: var(--card);
      border-radius: var(--radius);
      padding:16px;
      border: 1px solid rgba(109,40,217,0.10);
      box-shadow: var(--shadow);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    body[data-theme="dark"] .card-box {
      background: rgba(24,14,33,0.64);
      border-color: rgba(255,255,255,0.04);
      box-shadow: 0 14px 36px rgba(0,0,0,0.5);
    }
    .card-box:hover { transform: translateY(-2px); box-shadow: 0 20px 44px rgba(109,40,217,0.08); }

    .brand { font-weight:900; font-size:1.22rem; background: linear-gradient(90deg,var(--usm-purple),var(--usm-purple-2)); -webkit-background-clip:text; color:transparent; display:flex; gap:10px; align-items:center; }
    .subtitle { color:var(--muted); font-size:.95rem; }

    label.form-label { font-weight:600; font-size:.92rem; color:var(--muted); margin-bottom:6px; display:block; }
    .form-control, .form-select {
      border-radius:12px;
      padding:10px 12px;
      font-size:.95rem;
      background:#fbf8ff;
      border:1px solid rgba(109,40,217,0.06);
    }
    body[data-theme="dark"] .form-control, body[data-theme="dark"] .form-select {
      background: rgba(22,12,34,0.54);
      color: #efe6ff;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .form-control:focus, .form-select:focus { box-shadow: 0 0 0 6px rgba(167,139,250,0.14); outline:none; border-color:var(--usm-purple); }

    .logic-box {
      background:#f7f2ff;
      padding:10px;
      border-radius:10px;
      color:#3b2a63;
      min-height:56px;
    }
    body[data-theme="dark"] .logic-box { background: rgba(34,16,48,0.4); color:#efe6ff; }

    .btn { border-radius:12px; font-weight:700; }
    .btn-primary { background: linear-gradient(90deg,var(--usm-purple),var(--usm-purple-2)); border:none; color:#fff; }
    .btn-outline-secondary { color:var(--usm-purple); border-color:var(--usm-purple); border-radius:12px; }
    .btn-outline-secondary:hover { background:var(--usm-purple); color:#fff; }

    .nav-tabs { border-bottom:none; overflow:auto; white-space:nowrap; padding-bottom:6px; }
    .nav-tabs .nav-link { border:0; margin-right:6px; background:#f3eefe; color:var(--usm-purple); border-radius:10px; padding:7px 12px; }
    .nav-tabs .nav-link.active { background:var(--usm-purple); color:#fff; font-weight:700; }

    .muted { color:var(--muted); }
    .meta-item { margin-bottom:10px; }

    footer { margin-top:18px; text-align:center; color:var(--muted); font-size:.88rem; }

    @media (max-width: 991px) { .profile-row { flex-direction:column; gap:10px; } }
    @media (max-width: 575px) {
      .card-box { padding:12px; border-radius:12px; }
      .brand { font-size:1.05rem; }
      .form-control, .form-select { padding:8px 10px; }
      .btn { padding:7px 10px; font-size:.92rem; }
    }
  </style>
</head>

<body data-theme="light">
  <div class="container-app">

    <!-- HEADER -->
    <div class="card-box mb-3 d-flex justify-content-between align-items-center">
      <div>
        <div class="brand"><i class="bi bi-stars" style="font-size:1.1rem"></i> SCLOG</div>
        <div class="subtitle">Smart Course Learning Outcome Generator — logic & mapping</div>
      </div>
      <div>
        <button id="darkToggle" class="btn btn-outline-secondary"><i class="bi bi-moon"></i> Dark</button>
      </div>
    </div>

    <!-- 1) Academic profile + Level + IEG + PEO -->
    <div class="card-box mb-3">
      <div class="row g-3 profile-row">
        <div class="col-12 col-md-4">
          <label class="form-label">Academic profile</label>
          <select id="profile" class="form-select">
            <option value="">Select Academic profile</option>
            <option value="health">Medical & Health</option>
            <option value="sc">Computer Science & IT</option>
            <option value="eng">Engineering & Technology</option>
            <option value="socs">Social Sciences</option>
            <option value="edu">Education</option>
            <option value="bus">Business & Management</option>
            <option value="arts">Arts & Humanities</option>
          </select>
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Level</label>
          <select id="level" class="form-select">
            <option value="">Select Level</option>
            <option>Diploma</option>
            <option>Degree</option>
            <option>Master</option>
            <option>PhD</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">IEG</label>
          <select id="ieg" class="form-select"><option value="">Select IEG</option></select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">PEO (mapped)</label>
          <select id="peo" class="form-select"><option value="">Select PEO</option></select>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="form-label">Why this IEG → PEO?</div>
        <div id="ieg_peo_logic" class="logic-box">—</div>
      </div>
    </div>

    <!-- 2) PLO for selected PEO -->
    <div id="plo_block" class="card-box mb-3">
      <label class="form-label">PLO for selected PEO</label>
      <select id="plo" class="form-select mb-3"><option value="">Select PLO</option></select>

      <div class="mb-3">
        <div class="form-label">Why PEO → PLO?</div>
        <div id="peo_plo_logic" class="logic-box">—</div>
      </div>

      <div>
        <div><strong>PEO:</strong> <span id="peo_statement" class="muted">—</span></div>
        <div><strong>PLO:</strong> <span id="plo_statement" class="muted">—</span></div>
        <div><strong>Indicator:</strong> <span id="plo_indicator" class="muted">—</span></div>
      </div>
    </div>

    <!-- 3) Smart CLO Builder (main) -->
    <div class="card-box mb-3">
      <div class="row">
        <div class="col-12 col-xl-8">
          <h5 class="mb-1">Smart CLO Builder</h5>
          <div class="muted mb-2">Create measurable course learning outcomes quickly</div>

          <ul class="nav nav-tabs mb-3" id="tabNav" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#builderTab">Builder</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#variantsTab">Variants</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#assessmentTab">Assessment</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#historyTab">History</button></li>
          </ul>

          <div class="tab-content">
            <!-- BUILDER -->
            <div class="tab-pane fade show active" id="builderTab">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Bloom</label>
                  <select id="bloom" class="form-select"><option value="">Select Bloom</option></select>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Verb</label>
                  <select id="verb" class="form-select"><option value="">Select Verb</option></select>
                </div> 
                
                <div class="col-md-6">
                  <label class="form-label">Field (topic area)</label>
                  <select id="field" class="form-select">
                    <option value="" selected>— Select Field —</option>
                    <option>Computer Science</option>
                    <option>Medical & Health</option>
                    <option>Engineering</option>
                    <option>Social Sciences</option>
                    <option>Education</option>
                    <option>Business</option>
                    <option>Arts & Humanities</option>
                  </select>
                  <div id="content_suggestions" class="mt-2"></div>
                </div>

                <div class="col-12">
                  <label class="form-label">Content (topic / object)</label>
                  <input id="content" class="form-control" placeholder="e.g., interpret ECG waveforms">
                </div>

                <div class="col-12 d-flex gap-2 align-items-center">
                  <button id="generateBtn" class="btn btn-primary"><i class="bi bi-magic me-1"></i> Generate CLO</button>
                  <button id="copyBtn" class="btn btn-outline-secondary"><i class="bi bi-clipboard me-1"></i> Copy</button>
                  <div id="busy" class="muted" style="display:none">Generating…</div>
                </div>

                <div id="cloCard" class="col-12 card-box" style="display:none; margin-top:12px;">
                  <h6 class="mb-2">Generated CLO</h6>
                  <div id="clo_text" style="line-height:1.4; font-weight:600;"></div>

                  <div class="mt-3">
                    <button id="toggleVariants" class="btn btn-outline-secondary btn-sm">Show variants</button>
                    <div id="variantsPanel" style="display:none; margin-top:10px;"></div>
                  </div>

                  <div class="mt-3 d-flex gap-2">
                    <button id="downloadBtn" class="btn btn-success"><i class="bi bi-download me-1"></i> Download CLO</button>
                    <button id="downloadRubricBtn" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-text me-1"></i> Download Rubric</button>
                  </div>
                </div>

              </div>
            </div>

            <!-- VARIANTS -->
            <div class="tab-pane fade" id="variantsTab">
              <div id="variants_list" class="muted">Variants will appear after generating a CLO.</div>
            </div>

            <!-- ASSESSMENT -->
            <div class="tab-pane fade" id="assessmentTab">
              <div class="row g-3">
                <div class="col-md-6">
                  <div class="card-box">
                    <h6>Assessment methods</h6>
                    <div id="assess_list" class="muted">—</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card-box">
                    <h6>Suggested evidence</h6>
                    <div id="evidence_list" class="muted">—</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- HISTORY -->
            <div class="tab-pane fade" id="historyTab">
              <div class="card-box">
                <h6>Recent generation</h6>
                <div id="history_list" class="muted">Server-side history not enabled.</div>
              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT SIDEBAR: Mapping metadata -->
        <div class="col-12 col-xl-4">
          <div class="card-box mb-3">
            <div class="form-label">Mapping metadata</div>
            <div class="meta-item"><strong>SC Code:</strong><div id="sc_code" class="muted">—</div></div>
            <div class="meta-item"><strong>SC Description:</strong><div id="sc_desc" class="muted">—</div></div>
            <div class="meta-item"><strong>VBE:</strong><div id="vbe" class="muted">—</div></div>
            <div class="meta-item"><strong>Domain:</strong><div id="domain" class="muted">—</div></div>
            <div class="meta-item"><strong>Condition:</strong><div id="condition" class="muted">—</div></div>
            <div class="meta-item"><strong>Criterion:</strong><div id="criterion" class="muted">—</div></div>
          </div>

          <div class="card-box">
            <div class="form-label">Quick content suggestions</div>
            <div id="content_suggestions_right"></div>
          </div>
        </div>

      </div>
    </div>

    <footer>© 2025 • Assoc Prof Dr Hazwani Ahmad Yusof @ Hanafi — Universiti Sains Malaysia (USM)</footer>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script>
    // Short helper
    const $ = id => document.getElementById(id);

    // DOM refs (must match backend IDs)
    const profileSel = $('profile');
    const levelSel = $('level');
    const iegSel = $('ieg');
    const peoSel = $('peo');
    const ploSel = $('plo');

    const bloomSel = $('bloom');
    const verbSel = $('verb');
    const fieldSel = $('field');
    const contentInput = $('content');

    const iegLogicBox = $('ieg_peo_logic');
    const peoPloLogicBox = $('peo_plo_logic');

    const peoStatementEl = $('peo_statement');
    const ploStatementEl = $('plo_statement');
    const ploIndicatorEl = $('plo_indicator');

    const scCodeEl = $('sc_code');
    const scDescEl = $('sc_desc');
    const vbeEl = $('vbe');
    const domainEl = $('domain');
    const conditionEl = $('condition');
    const criterionEl = $('criterion');

    const generateBtn = $('generateBtn');
    const copyBtn = $('copyBtn');
    const busyEl = $('busy');
    const cloCard = $('cloCard');
    const cloText = $('clo_text');
    const toggleVariantsBtn = $('toggleVariants');
    const variantsPanel = $('variantsPanel');
    const variants_list = $('variants_list');

    const assessList = $('assess_list');
    const evidenceList = $('evidence_list');

    const downloadBtn = $('downloadBtn');
    const downloadRubricBtn = $('downloadRubricBtn');
    const darkToggle = $('darkToggle');

    const contentSuggestionsEl = $('content_suggestions');
    const contentSuggestionsRight = $('content_suggestions_right');

    let MAP = {};
    let LAST_CLO = null;

    // Theme toggle
    darkToggle.addEventListener('click', () => {
      const curr = document.body.getAttribute('data-theme') || 'light';
      const next = curr === 'light' ? 'dark' : 'light';
      document.body.setAttribute('data-theme', next);
      darkToggle.innerHTML = next === 'dark' ? '<i class="bi bi-sun"></i> Light' : '<i class="bi bi-moon"></i> Dark';
      logEvent('toggle_theme', { theme: next });
    });

    // Load mapping (IEGs/PEOs/PLOs) from backend
    async function loadMapping() {
      try {
        const res = await fetch('/api/mapping');
        MAP = await res.json();
        // Populate IEGs
        iegSel.innerHTML = '<option value="">Select IEG</option>';
        (MAP.IEGs || []).forEach(i => iegSel.add(new Option(i, i)));
        // Set PLO fallback list if present
        ploSel.innerHTML = '<option value="">Select PLO</option>';
        (MAP.PLOs || []).forEach(p => ploSel.add(new Option(p, p)));
      } catch (e) {
        console.error('loadMapping error', e);
      }
    }

    /* IEG -> PEO mapping + logic */
    iegSel.addEventListener('change', async () => {
      const ieg = iegSel.value;
      peoSel.innerHTML = '<option value="">Select PEO</option>';
      ploSel.innerHTML = '<option value="">Select PLO</option>';
      iegLogicBox.textContent = '—';
      peoStatementEl.textContent = '—';
      ploStatementEl.textContent = '—';
      ploIndicatorEl.textContent = '—';
      logEvent('ieg_select', { ieg });

      if (!ieg) return;
      try {
        const r = await fetch(`/api/get_peos/${encodeURIComponent(ieg)}`);
        const peos = await r.json();
        peoSel.innerHTML = '<option value="">Select PEO</option>';
        (peos || []).forEach(p => peoSel.add(new Option(p, p)));
      } catch (e) { console.error(e); }

      try {
        const r2 = await fetch(`/api/logic/ieg_peo/${encodeURIComponent(ieg)}`);
        const txt = await r2.text();
        iegLogicBox.textContent = txt && txt.trim() ? txt : 'No logic explanation available.';
      } catch (e) { console.error(e); iegLogicBox.textContent = 'Logic unavailable.'; }
    });

    /* PEO -> PLO mapping + statements */
    peoSel.addEventListener('change', async () => {
      const peo = peoSel.value;
      ploSel.innerHTML = '<option value="">Select PLO</option>';
      peoPloLogicBox.textContent = '—';
      peoStatementEl.textContent = '—';
      ploStatementEl.textContent = '—';
      ploIndicatorEl.textContent = '—';
      logEvent('peo_select', { peo });

      if (!peo) return;
      try {
        const r = await fetch(`/api/get_plos/${encodeURIComponent(peo)}`);
        const plos = await r.json();
        ploSel.innerHTML = '<option value="">Select PLO</option>';
        (plos || []).forEach(p => ploSel.add(new Option(p, p)));
      } catch (e) { console.error(e); }

      try {
        const level = levelSel.value || 'Degree';
        const sres = await fetch(`/api/get_statement/${encodeURIComponent(level)}/PEO/${encodeURIComponent(peo)}`);
        const stmt = await sres.json();
        peoStatementEl.textContent = stmt || '—';
      } catch(e) { console.error(e); }
    });

    /* PLO -> blooms + PEO→PLO logic + statements + indicator + meta */
    ploSel.addEventListener('change', async () => {
      const plo = ploSel.value;
      const peo = peoSel.value;
      bloomSel.innerHTML = '<option value="">Select Bloom</option>';
      peoPloLogicBox.textContent = '—';
      ploStatementEl.textContent = '—';
      ploIndicatorEl.textContent = '—';
      scCodeEl.textContent = '—';
      scDescEl.textContent = '—';
      vbeEl.textContent = '—';
      domainEl.textContent = '—';
      conditionEl.textContent = '—';
      criterionEl.textContent = '—';
      logEvent('plo_select', { plo, peo });

      if (!plo) return;

      try {
        const r = await fetch(`/api/logic/peo_plo/${encodeURIComponent(peo)}/${encodeURIComponent(plo)}`);
        const txt = await r.text();
        peoPloLogicBox.textContent = txt && txt.trim() ? txt : 'No logic explanation available.';
      } catch(e) { console.error(e); peoPloLogicBox.textContent = 'Logic unavailable.'; }

      try {
        const res = await fetch(`/api/get_blooms/${encodeURIComponent(plo)}?profile=${encodeURIComponent(profileSel.value)}`);
        const blooms = await res.json();
        bloomSel.innerHTML = '<option value="">Select Bloom</option>';
        (blooms || []).forEach(b => bloomSel.add(new Option(b, b)));
      } catch(e) { console.error(e); bloomSel.innerHTML = '<option value="">Error</option>'; }

      try {
        const level = levelSel.value || 'Degree';
        const sres = await fetch(`/api/get_statement/${encodeURIComponent(level)}/PLO/${encodeURIComponent(plo)}`);
        const stmt = await sres.json();
        ploStatementEl.textContent = stmt || '—';
      } catch(e){ console.error(e); }

      try {
        ploIndicatorEl.textContent = (MAP.PLOIndicators && MAP.PLOIndicators[plo]) || '—';
      } catch(e){ ploIndicatorEl.textContent = '—'; }

      try {
        const mres = await fetch(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloomSel.value || '')}`);
        const meta = await mres.json();
        scCodeEl.textContent = meta.sc_code || '—';
        scDescEl.textContent = meta.sc_desc || '—';
        vbeEl.textContent = meta.vbe || '—';
        domainEl.textContent = meta.domain || '—';
        conditionEl.textContent = meta.condition || '—';
        criterionEl.textContent = meta.criterion || '—';
      } catch(e){ console.error(e); }
    });

    /* Bloom -> verbs + meta when bloom chosen */
    bloomSel.addEventListener('change', async () => {
      const bloom = bloomSel.value; const plo = ploSel.value;
      if (!bloom || !plo) return;
      logEvent('bloom_select', { bloom, plo });

      try {
        const vres = await fetch(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`);
        const verbs = await vres.json();
        verbSel.innerHTML = '<option value="">Select Verb</option>';
        (verbs || []).forEach(v => verbSel.add(new Option(v, v)));
      } catch(e){ console.error(e); verbSel.innerHTML = '<option value="">Error</option>'; }

      try {
        const mres = await fetch(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(bloom)}?profile=${encodeURIComponent(profileSel.value)}`);
        const meta = await mres.json();
        scCodeEl.textContent = meta.sc_code || '—';
        scDescEl.textContent = meta.sc_desc || '—';
        vbeEl.textContent = meta.vbe || '—';
        domainEl.textContent = meta.domain || '—';
        conditionEl.textContent = meta.condition || '—';
        criterionEl.textContent = meta.criterion || '—';
      } catch(e){ console.error(e); }
    });

    /* Field -> content suggestions */
    fieldSel.addEventListener('change', async () => {
      const field = fieldSel.value;
      contentSuggestionsEl.innerHTML = '';
      contentSuggestionsRight.innerHTML = '';
      logEvent('field_select', { field });
      if (!field) return;
      try {
        const res = await fetch(`/api/content/${encodeURIComponent(field)}`);
        const list = await res.json();
        (list || []).forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'btn btn-sm btn-light me-1 mb-1';
          btn.textContent = s;
          btn.onclick = () => { contentInput.value = s; };
          contentSuggestionsEl.appendChild(btn);

          const small = document.createElement('div');
          small.className = 'muted mb-1';
          small.textContent = s;
          contentSuggestionsRight.appendChild(small);
        });
      } catch(e){ console.error(e); }
    });

    profileSel.addEventListener('change', () => logEvent('profile_select', { profile: profileSel.value }));
    levelSel.addEventListener('change', () => logEvent('level_select', { level: levelSel.value }));

    /* Generate CLO */
    generateBtn.addEventListener('click', async () => {
      if (!ploSel.value || !bloomSel.value || !verbSel.value || !contentInput.value.trim()) {
        alert('Please fill PLO, Bloom, Verb and Content.');
        return;
      }
      busyEl.style.display = 'inline';
      generateBtn.disabled = true;

      const fd = new FormData();
      fd.append('profile', profileSel.value);
      fd.append('level', levelSel.value);
      fd.append('plo', ploSel.value);
      fd.append('bloom', bloomSel.value);
      fd.append('verb', verbSel.value);
      fd.append('content', contentInput.value);

      logEvent('generate_clo_attempt', { plo: ploSel.value, bloom: bloomSel.value, verb: verbSel.value });

      try {
        const res = await fetch('/generate', { method:'POST', body: fd });
        if (!res.ok) { const err = await res.text().catch(()=> 'server error'); throw new Error(err); }
        const data = await res.json();
        LAST_CLO = data;

        cloText.innerText = data.clo || '';
        cloCard.style.display = 'block';

        variantsPanel.innerHTML = '';
        const opts = data.variants || data.clo_options || {};
        Object.entries(opts).forEach(([label, text]) => {
          const div = document.createElement('div');
          div.className = 'logic-box mb-2';
          div.style.cursor = 'pointer';
          div.innerHTML = `<strong>${label}</strong><div class="mt-1">${text}</div>`;
          div.onclick = () => cloText.innerText = text;
          variantsPanel.appendChild(div);
        });

        variants_list.innerHTML = '';
        Object.entries(opts).forEach(([label, text]) => {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${label}:</strong> ${text}`;
          variants_list.appendChild(p);
        });

        const assessments = data.assessments || [];
        assessList.innerHTML = assessments.length ? ('<ul>' + assessments.map(a => `<li>${a}</li>`).join('') + '</ul>') : '—';
        const evidence = data.evidence || {};
        evidenceList.innerHTML = Object.keys(evidence).length ? Object.entries(evidence).map(([k,v]) => `<div><strong>${k}</strong>: ${v.join('; ')}</div>`).join('') : '—';

        peoStatementEl.textContent = data.peo_statement || '—';
        ploStatementEl.textContent = data.plo_statement || '—';
        ploIndicatorEl.textContent = data.plo_indicator || '—';

        logEvent('generate_clo', { plo: ploSel.value, bloom: bloomSel.value, verb: verbSel.value });

      } catch (e) {
        console.error(e);
        alert('Error generating CLO. See console for details.');
        logEvent('generate_clo_error', { error: (e.message || String(e)) });
      } finally {
        busyEl.style.display = 'none';
        generateBtn.disabled = false;
      }
    });

    /* Copy CLO */
    copyBtn.addEventListener('click', async () => {
      if (!cloText.innerText) return;
      try {
        await navigator.clipboard.writeText(cloText.innerText);
        copyBtn.innerText = 'Copied';
        setTimeout(()=> copyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i> Copy', 1200);
        logEvent('copy_clo', { plo: ploSel.value || null });
      } catch(e) { alert('Copy failed'); }
    });

    /* Downloads */
    downloadBtn.addEventListener('click', () => {
      logEvent('download_clo', { plo: ploSel.value || null });
      window.location = '/download';
    });
    downloadRubricBtn.addEventListener('click', () => {
      logEvent('download_rubric', { plo: ploSel.value || null });
      window.location = '/download_rubric';
    });

    /* Toggle variants */
    toggleVariantsBtn.addEventListener('click', () => {
      const hidden = variantsPanel.style.display === 'none' || variantsPanel.style.display === '';
      variantsPanel.style.display = hidden ? 'block' : 'none';
      toggleVariantsBtn.innerText = hidden ? 'Hide variants' : 'Show variants';
      logEvent('variants_toggle', { visible: hidden });
    });

    // tab click events
    document.querySelectorAll('#tabNav .nav-link').forEach(tab => {
      tab.addEventListener('click', () => logEvent('tab_click', { tab: tab.textContent.trim() }));
    });

    ploSel.addEventListener('change', () => logEvent('peo_plo_check', { peo: peoSel.value, plo: ploSel.value }));

    /* init() - call last, after listeners defined */
    (function init(){
      loadMapping();

      // Make field default to "— Select Field —"
      if (fieldSel) {
        fieldSel.value = "";
        fieldSel.selectedIndex = 0;
      }

      // Clear suggestions on page load
      if (contentSuggestionsEl) {
        contentSuggestionsEl.innerHTML = "";
      }
      if (contentSuggestionsRight) {
        contentSuggestionsRight.innerHTML = "";
      }

      // track page init
      logEvent('page_init', { page: 'generator' });

    })();
  </script>
</body>
</html>
