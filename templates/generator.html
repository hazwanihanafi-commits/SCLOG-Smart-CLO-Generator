<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SCLOG ‚Äî Smart CLO Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap + icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HMBYNXRLBE"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HMBYNXRLBE', { 'send_page_view': true });

    function logEvent(name, data = {}) {
      if (typeof gtag === 'function') {
        try { gtag('event', name, data); } catch(e){ console.debug('gtag error', e); }
      } else {
        console.debug('GA not ready - event', name, data);
      }
    }
  </script>

  <!-- Theme CSS -->
  <style>
    :root{
      --usm-purple: #6d28d9;
      --usm-purple-2: #8b5cf6;
      --bg-light: #f5f3ff;
      --card: #ffffff;
      --muted: #6c6480;
      --radius: 14px;
      --shadow: 0 10px 30px rgba(15,23,42,0.06);
    }

    .app-title {
  font-weight: 900;
  font-size: 1.6rem;        /* strongest */
  letter-spacing: 0.3px;
  background: linear-gradient(90deg,#6d28d9,#8b5cf6);
  -webkit-background-clip: text;
  color: transparent;
}

.app-brand {
  display: inline-flex;
  align-items: center;
}

.app-subtitle {
  font-size: 1rem;
  color: #6b7280;
  margin-top: 2px;
}

    .smart-title {
  font-weight: 700;      /* less than app-title */
  font-size: 1.05rem;
  color: #6d28d9;
}
    .smart-divider {
  height: 3px;
  width: 60px;
  background: linear-gradient(90deg, var(--usm-purple), var(--usm-purple-2));
  border-radius: 2px;
}

    html,body{height:100%;}
    body {
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: var(--bg-light);
      color: #2a2344;
      line-height:1.45;
    }
    body[data-theme="dark"] {
      background: linear-gradient(180deg,#11101a,#16081f);
      color: #efe6ff;
    }

    .container-app {
      max-width:1200px;
      margin:18px auto 40px;
      padding:12px;
    }

   .step-header {
  font-weight: 800;
  font-size: 1.05rem;
  color: #4c1d95;
  margin-bottom: 4px;
}

.step-desc {
  font-size: 0.9rem;
  color: #6b7280;
  margin-bottom: 14px;
}

.step-divider {
  border-top: 1px dashed rgba(109,40,217,0.25);
  margin: 14px 0 18px;
}

    .step-strong{
  font-size:1.15rem;
  font-weight:900;
}

    .step-pill{
  font-size:0.7rem;
  font-weight:800;
  letter-spacing:0.08em;
  color:#6d28d9;
  background:#ede9fe;
  padding:4px 10px;
  border-radius:999px;
}

    .bloom-tag{
  font-size:0.7rem;
  font-weight:900;
  letter-spacing:0.05em;
  background:#ede9fe;
  color:#6d28d9;
  padding:4px 8px;
  border-radius:999px;
}
    

    .card-box {
      background: var(--card);
      border-radius: var(--radius);
      padding:16px;
      border: 1px solid rgba(109,40,217,0.10);
      box-shadow: var(--shadow);
      transition: transform .12s ease, box-shadow .12s ease;
    }
    body[data-theme="dark"] .card-box {
      background: rgba(24,14,33,0.64);
      border-color: rgba(255,255,255,0.04);
      box-shadow: 0 14px 36px rgba(0,0,0,0.5);
    }
    .card-box:hover { transform: translateY(-2px); box-shadow: 0 20px 44px rgba(109,40,217,0.08); }

    .brand { font-weight:900; font-size:1.22rem; background: linear-gradient(90deg,var(--usm-purple),var(--usm-purple-2)); -webkit-background-clip:text; color:transparent; display:flex; gap:10px; align-items:center; }
    .subtitle { color:var(--muted); font-size:.95rem; }

    label.form-label { font-weight:600; font-size:.92rem; color:var(--muted); margin-bottom:6px; display:block; }
    .form-control, .form-select {
      border-radius:12px;
      padding:10px 12px;
      font-size:.95rem;
      background:#fbf8ff;
      border:1px solid rgba(109,40,217,0.06);
    }
    body[data-theme="dark"] .form-control, body[data-theme="dark"] .form-select {
      background: rgba(22,12,34,0.54);
      color: #efe6ff;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .form-control:focus, .form-select:focus { box-shadow: 0 0 0 6px rgba(167,139,250,0.14); outline:none; border-color:var(--usm-purple); }

    .logic-box {
      background:#f7f2ff;
      padding:10px;
      border-radius:10px;
      color:#3b2a63;
      min-height:56px;
    }
    body[data-theme="dark"] .logic-box { background: rgba(34,16,48,0.4); color:#efe6ff; }

    .btn { border-radius:12px; font-weight:700; }
    .btn-primary { background: linear-gradient(90deg,var(--usm-purple),var(--usm-purple-2)); border:none; color:#fff; }
    .btn-outline-secondary { color:var(--usm-purple); border-color:var(--usm-purple); border-radius:12px; }
    .btn-outline-secondary:hover { background:var(--usm-purple); color:#fff; }

    .nav-tabs { border-bottom:none; overflow:auto; white-space:nowrap; padding-bottom:6px; }
    .nav-tabs .nav-link { border:0; margin-right:6px; background:#f3eefe; color:var(--usm-purple); border-radius:10px; padding:7px 12px; }
    .nav-tabs .nav-link.active { background:var(--usm-purple); color:#fff; font-weight:700; }

    .muted { color:var(--muted); }
    .meta-item { margin-bottom:10px; }

    footer { margin-top:18px; text-align:center; color:var(--muted); font-size:.88rem; }

    @media (max-width: 991px) { .profile-row { flex-direction:column; gap:10px; } }
    @media (max-width: 575px) {
      .card-box { padding:12px; border-radius:12px; }
      .brand { font-size:1.05rem; }
      .form-control, .form-select { padding:8px 10px; }
      .btn { padding:7px 10px; font-size:.92rem; }
    }
  </style>
</head>

<body data-theme="light">
  <div class="container-app">

    <!-- HEADER -->
    <div class="card-box mb-3 d-flex justify-content-between align-items-center">
      <div>
        <div class="app-title">
  <span class="app-brand">
    <i class="bi bi-stars me-1"></i> SCLOG
  </span>
</div>
<div class="app-subtitle">
  Smart Course Learning Outcome Generator ‚Äî logic & mapping
</div>
      <div>
        <button id="darkToggle" class="btn btn-outline-secondary"><i class="bi bi-moon"></i> Dark</button>
      </div>
    </div>

    <!-- STEP 1 -->
<div class="card-box mb-3">

  <div class="d-flex align-items-center gap-2 mb-1">
    <span class="step-pill">STEP 1</span>
    <div class="step-header mb-0">
      Programme Context
    </div>
  </div>

  <div class="step-desc">
    Define the academic discipline, level, and intended graduate attributes
    to guide appropriate outcome mapping.
  </div>

    <div class="step-divider"></div>
      
      <div class="row g-3 profile-row">
        <div class="col-12 col-md-4">
          <label class="form-label">Academic profile</label>
          <select id="profile" class="form-select">
            <option value="">Select Academic profile</option>
            <option value="health">Medical & Health</option>
            <option value="sc">Computer Science & IT</option>
            <option value="eng">Engineering & Technology</option>
            <option value="socs">Social Sciences</option>
            <option value="edu">Education</option>
            <option value="bus">Business & Management</option>
            <option value="arts">Arts & Humanities</option>
          </select>
        </div>

        <div class="col-12 col-md-2">
          <label class="form-label">Level</label>
          <select id="level" class="form-select">
            <option value="">Select Level</option>
            <option>Diploma</option>
            <option>Degree</option>
            <option>Master</option>
            <option>PhD</option>
          </select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">IEG</label>
          <select id="ieg" class="form-select"><option value="">Select IEG</option></select>
        </div>

        <div class="col-12 col-md-3">
          <label class="form-label">PEO (mapped)</label>
          <select id="peo" class="form-select"><option value="">Select PEO</option></select>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="form-label">Why this IEG ‚Üí PEO?</div>
        <div id="ieg_peo_logic" class="logic-box">‚Äî</div>
      </div>
    </div>

    <!-- 2) PLO for selected PEO -->

      <!-- STEP 2 -->
<div class="card-box mb-3">

  <div class="d-flex align-items-center gap-2 mb-1">
    <span class="step-pill">STEP 2</span>
    <div class="step-header mb-0">
      Programme Learning Outcomes (PLO)
    </div>
  </div>

  <div class="step-desc">
    Select the Programme Learning Outcome (PLO) aligned with the selected
    Programme Educational Objective (PEO).
  </div>

  <div class="step-divider"></div>

  <label class="form-label">PLO for selected PEO</label>
  <select id="plo" class="form-select mb-3">
    <option value="">Select PLO</option>
  </select>

  <div class="mb-3">
    <div class="form-label">Why PEO ‚Üí PLO?</div>
    <div id="peo_plo_logic" class="logic-box">‚Äî</div>
  </div>

  <div>
    <div><strong>PEO:</strong> <span id="peo_statement" class="muted">‚Äî</span></div>
    <div><strong>PLO:</strong> <span id="plo_statement" class="muted">‚Äî</span></div>
    <div><strong>Indicator:</strong> <span id="plo_indicator" class="muted">‚Äî</span></div>
  </div>

</div>

    <!-- 3) Smart CLO Builder (main) -->
    <div class="card-box mb-3">
        <div class="col-12 col-xl-8">
          <div class="d-flex align-items-center gap-2 mb-1">
  <h4 class="smart-title mb-0">
    <i class="bi bi-lightning-charge-fill me-1"></i>
    Smart CLO Builder
  </h4>

  <!-- Auto Bloom tag -->
  <span id="bloomTag" class="bloom-tag">‚Äî</span>
</div>
          
<div class="smart-divider mb-2"></div>

          <div class="step-header">Step 3 ¬∑ Course Learning Outcome (CLO) Construction</div>
<div class="step-desc">
  Construct a measurable Course Learning Outcome using Bloom‚Äôs Taxonomy,
  suitable action verbs, and clear content focus.
</div>
<div class="step-divider"></div>

          <div class="muted mb-2">Create measurable course learning outcomes quickly</div>

          <ul class="nav nav-tabs mb-3" id="tabNav" role="tablist">
            <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#builderTab">Builder</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#variantsTab">Variants</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#assessmentTab">Assessment</button></li>
            <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#historyTab">History</button></li>
          </ul>

          <div class="tab-content">
            <!-- BUILDER -->
            <div class="tab-pane fade show active" id="builderTab">
              <div class="row g-3">
                <div class="col-md-6">
  <label class="form-label">Bloom</label>
  <select id="bloom" class="form-select">
    <option value="">Select Bloom</option>
  </select>

  <!-- Bloom description (UI only) -->
  <div id="bloom_desc" class="muted mt-1" style="font-size:0.85rem;">
    Select a Bloom level to see its description.
  </div>
</div>

 <div id="bloom_hint" class="mt-1" style="font-size:0.85rem; line-height:1.4;">
  <span class="muted">Select a Bloom level to see recommendations.</span>
</div>
                
                <div class="form-check form-switch mt-2">
  <input class="form-check-input" type="checkbox" id="autoShowAssessment" checked>
  <label class="form-check-label muted" for="autoShowAssessment">
    Auto show assessment & evidence
  </label>
</div>


                <div class="col-md-6">
                  <label class="form-label">Verb</label>
                  <select id="verb" class="form-select"><option value="">Select Verb</option></select>
                </div> 
                
                <div class="col-md-6">
                  <label class="form-label">Field (topic area)</label>
                  <select id="field" class="form-select">
                    <option value="" selected>‚Äî Select Field ‚Äî</option>
                    <option>Computer Science</option>
                    <option>Medical & Health</option>
                    <option>Engineering</option>
                    <option>Social Sciences</option>
                    <option>Education</option>
                    <option>Business</option>
                    <option>Arts & Humanities</option>
                  </select>
                  <div id="content_suggestions" class="mt-2"></div>
                </div>

                <div class="col-12">
                  <label class="form-label">
  Content (learning focus / object)
</label>
<div class="muted mb-1" style="font-size:0.85rem">
  Specify <strong>what</strong> the student will work on (procedure, concept,
  skill, case, or professional task).
</div>
<input id="content" class="form-control"
       placeholder="e.g., ECG waveform interpretation, laboratory testing procedure, ethical case scenario">
</div>
                <div class="col-12 d-flex gap-2 align-items-center">
                  <button id="generateBtn" class="btn btn-primary"><i class="bi bi-magic me-1"></i> Generate CLO</button>
                  <button id="copyBtn" class="btn btn-outline-secondary"><i class="bi bi-clipboard me-1"></i> Copy</button>
                  <div id="busy" class="muted" style="display:none">Generating‚Ä¶</div>
                </div>

                <div id="cloCard" class="col-12 card-box" style="display:none; margin-top:12px;">
                  <h6 class="mb-2">Generated CLO</h6>
                  <div id="clo_text" style="line-height:1.4; font-weight:600;"></div>

                  <div class="mt-3">
                    <button id="toggleVariants" class="btn btn-outline-secondary btn-sm">Show variants</button>
                    <div id="variantsPanel" style="display:none; margin-top:10px;"></div>
                  </div>

                  <div class="mt-3 d-flex gap-2">
                    <button id="downloadBtn" class="btn btn-success"><i class="bi bi-download me-1"></i> Download CLO</button>
                    <button id="downloadRubricBtn" class="btn btn-outline-secondary"><i class="bi bi-file-earmark-text me-1"></i> Download Rubric</button>
                  </div>
                </div>

              </div>
            </div>

            <!-- VARIANTS -->
            <div class="tab-pane fade" id="variantsTab">
              <div id="variants_list" class="muted">Variants will appear after generating a CLO.</div>
            </div>

            <!-- ASSESSMENT -->
<div class="tab-pane fade" id="assessmentTab">

  <div class="step-header">Step 4 ¬∑ Assessment & Evidence</div>
  <div class="step-desc">
    Recommended assessment methods and supporting evidence aligned with
    the selected Bloom‚Äôs domain and CLO.
  </div>
  <div class="step-divider"></div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card-box">
        <h6>Assessment methods</h6>
        <div id="assess_list" class="muted">‚Äî</div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card-box">
        <h6>Suggested evidence</h6>
        <div id="evidence_list" class="muted">‚Äî</div>
      </div>
    </div>
  </div>

</div>
            <!-- HISTORY -->
            <div class="tab-pane fade" id="historyTab">
              <div class="card-box">
                <h6>Recent generation</h6>
                <div id="history_list" class="muted">Server-side history not enabled.</div>
              </div>
            </div>

          </div>
        </div>

        <!-- RIGHT SIDEBAR: Mapping metadata -->
        <div class="col-12 col-xl-4">
          <div class="card-box mb-3">
            <div class="form-label">Mapping metadata</div>
            <div class="meta-item"><strong>SC Code:</strong><div id="sc_code" class="muted">‚Äî</div></div>
            <div class="meta-item"><strong>SC Description:</strong><div id="sc_desc" class="muted">‚Äî</div></div>
            <div class="meta-item"><strong>VBE:</strong><div id="vbe" class="muted">‚Äî</div></div>
            <div class="meta-item"><strong>Domain:</strong><div id="domain" class="muted">‚Äî</div></div>
            <div class="meta-item"><strong>Condition:</strong><div id="condition" class="muted">‚Äî</div></div>
            <div class="meta-item"><strong>Criterion:</strong><div id="criterion" class="muted">‚Äî</div></div>
          </div>

          <div class="card-box">
            <div class="form-label">Quick content suggestions</div>
            <div id="content_suggestions_right"></div>
          </div>
        </div>

      </div>
    </div>

    <footer>¬© 2025 ‚Ä¢ Assoc Prof Dr Hazwani Ahmad Yusof @ Hanafi ‚Äî Universiti Sains Malaysia (USM)</footer>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script>
/* =========================
   SHORT HELPER
========================= */
const $ = id => document.getElementById(id);

/* =========================
   DOM REFERENCES
========================= */
const profileSel = $('profile');
const levelSel = $('level');
const iegSel = $('ieg');
const peoSel = $('peo');
const ploSel = $('plo');

const bloomSel = $('bloom');
const verbSel = $('verb');
const fieldSel = $('field');
const contentInput = $('content');

const iegLogicBox = $('ieg_peo_logic');
const peoPloLogicBox = $('peo_plo_logic');

const peoStatementEl = $('peo_statement');
const ploStatementEl = $('plo_statement');
const ploIndicatorEl = $('plo_indicator');

const scCodeEl = $('sc_code');
const scDescEl = $('sc_desc');
const vbeEl = $('vbe');
const domainEl = $('domain');
const conditionEl = $('condition');
const criterionEl = $('criterion');

const generateBtn = $('generateBtn');
const copyBtn = $('copyBtn');
const busyEl = $('busy');
const cloCard = $('cloCard');
const cloText = $('clo_text');
const toggleVariantsBtn = $('toggleVariants');
const variantsPanel = $('variantsPanel');
const variants_list = $('variants_list');

const assessList = $('assess_list');
const evidenceList = $('evidence_list');

const downloadBtn = $('downloadBtn');
const downloadRubricBtn = $('downloadRubricBtn');
const darkToggle = $('darkToggle');

const contentSuggestionsEl = $('content_suggestions');
const contentSuggestionsRight = $('content_suggestions_right');

const bloomDescEl = $('bloom_desc');

/* =========================
   STATE
========================= */
let MAP = {};
let LAST_CLO = null;
let AUTO_SHOW_ASSESSMENT = true;

const autoShowToggle = document.getElementById("autoShowAssessment");
if (autoShowToggle) {
  AUTO_SHOW_ASSESSMENT = autoShowToggle.checked;
  autoShowToggle.addEventListener("change", () => {
    AUTO_SHOW_ASSESSMENT = autoShowToggle.checked;
  });
}
    

/* =========================
   BLOOM DESCRIPTIONS
========================= */
const BLOOM_DESC = {
  /* Cognitive */
  remember: "Recall facts, terms, or basic concepts.",
  understand: "Explain ideas or concepts in your own words.",
  apply: "Use knowledge in new but familiar situations.",
  analyze: "Break information into parts and examine relationships.",
  evaluate: "Make judgments based on criteria or standards.",
  create: "Produce new or original work by combining elements.",

  /* Affective */
  receiving: "Willingness to attend to or be aware of stimuli.",
  responding: "Active participation by responding or reacting.",
  valuing: "Demonstrating commitment or belief in a value.",
  organization: "Integrating values into a consistent value system.",
  characterization: "Acting consistently according to internalised values.",

  /* Psychomotor */
  perception: "Use sensory cues to guide motor activity.",
  set: "Demonstrate readiness to perform a skill.",
  "guided response": "Perform skill under guidance or imitation.",
  mechanism: "Carry out skill with confidence and proficiency.",
  "complex overt response": "Perform complex skills smoothly and accurately.",
  adaptation: "Modify learned skills to suit new situations.",
  origination: "Create new movement patterns or procedures."
};

    /* =========================
   BLOOM RECOMMENDATION BY LEVEL
   (Cognitive, Affective, Psychomotor)
========================= */
const BLOOM_RECOMMENDATION_BY_LEVEL = {
  Diploma: {
    cognitive: ["Remember", "Understand", "Apply"],
    affective: ["Receiving", "Responding"],
    psychomotor: ["Perception", "Set", "Guided Response"],
    caution: ["Evaluate", "Create", "Adaptation", "Origination"]
  },

  Degree: {
    cognitive: ["Understand", "Apply", "Analyze"],
    affective: ["Responding", "Valuing"],
    psychomotor: ["Guided Response", "Mechanism"],
    caution: ["Remember", "Create", "Origination"]
  },

  Master: {
    cognitive: ["Analyze", "Evaluate", "Create"],
    affective: ["Valuing", "Organization"],
    psychomotor: ["Mechanism", "Complex Overt Response", "Adaptation"],
    caution: ["Remember", "Understand"]
  },

  PhD: {
    cognitive: ["Create"],
    affective: ["Characterization"],
    psychomotor: ["Adaptation", "Origination"],
    caution: ["Remember", "Understand", "Apply"]
  }
};
    
/* =========================
   ASSESSMENT & EVIDENCE
========================= */
const ASSESSMENT_MAP = {
  remember: {
    assessments: ["MCQ","True/False","Matching","Short-answer","Online quiz"],
    evidence: ["Exam paper","Answer key","LMS report"]
  },
  understand: {
    assessments: ["Short essay","Concept map","Oral questioning","Viva"],
    evidence: ["Essay script","Rubric","Viva sheet"]
  },
  apply: {
    assessments: ["Problem-solving","Simulation","Practical task","Short case"],
    evidence: ["Lab report","Checklist","Assessor notes"]
  },
  analyze: {
    assessments: ["Case study","Long case","Data analysis"],
    evidence: ["Analytical report","Annotated script"]
  },
  evaluate: {
    assessments: ["Critical review","Debate","Viva"],
    evidence: ["Review paper","Peer evaluation","Reflection"]
  },
  create: {
    assessments: ["Project","Capstone","Research proposal"],
    evidence: ["Project report","Prototype","Supervisor feedback"]
  },

  /* Affective */

  /* Affective (legacy support) */
receive: {
  assessments: ["Observation","Attendance-based task"],
  evidence: ["Observation checklist","Attendance record"]
},
respond: {
  assessments: ["Class participation","Reflective journal","Forum discussion"],
  evidence: ["Participation rubric","Reflection log"]
},
value: {
  assessments: ["Reflective essay","Ethics case reflection"],
  evidence: ["Reflection essay","Rubric","Assessor comments"]
},
  receiving: {
    assessments: ["Observation","Attendance-based task"],
    evidence: ["Observation checklist","Attendance record"]
  },
  responding: {
    assessments: ["Class participation","Reflective journal","Forum discussion"],
    evidence: ["Participation rubric","Reflection log"]
  },
  valuing: {
    assessments: ["Reflective essay","Ethics case reflection"],
    evidence: ["Reflection essay","Rubric","Assessor comments"]
  },
  organization: {
    assessments: ["Portfolio","Ethical reasoning task"],
    evidence: ["Portfolio artefact","Evaluation rubric"]
  },
  characterization: {
    assessments: ["Professional behaviour assessment","WBA"],
    evidence: ["Supervisor evaluation","Professional logbook"]
  },

  /* Psychomotor */
  perception: {
    assessments: ["Skill observation"],
    evidence: ["Observation checklist"]
  },
  set: {
    assessments: ["Equipment setup","Readiness check"],
    evidence: ["Setup checklist"]
  },
  "guided response": {
    assessments: ["Supervised practice","OSPE"],
    evidence: ["Skills checklist"]
  },
  mechanism: {
    assessments: ["OSCE","Practical exam"],
    evidence: ["Scoring rubric","Examiner sheet"]
  },
  "complex overt response": {
    assessments: ["Integrated task","Long case","Short case"],
    evidence: ["Performance rubric","Video evidence"]
  },
  adaptation: {
    assessments: ["Adaptive scenario"],
    evidence: ["Assessor report"]
  },
  origination: {
    assessments: ["Innovation project"],
    evidence: ["Project artefact","Evaluation rubric"]
  }
};

    function renderAssessmentFromBloom(key) {
  const ae = ASSESSMENT_MAP[key];
  if (!ae) return;

  assessList.innerHTML =
    "<ul>" +
    ae.assessments.map(a => `<li>${a}</li>`).join("") +
    "</ul>";

  evidenceList.innerHTML =
    "<ul>" +
    ae.evidence.map(e => `<li>${e}</li>`).join("") +
    "</ul>";
}
  

/* =========================
   NORMALISE BLOOM
========================= */
function normaliseBloomKey(value) {
  if (!value) return "";

  const v = value
    .toLowerCase()
    .replace(/\(.*?\)/g, "")   // buang (affective)
    .replace(/\s+/g, " ")
    .trim();

  // Affective
  if (v.includes("receiving") || v === "receive") return "receiving";
  if (v.includes("responding") || v === "respond") return "responding";
  if (v.includes("valuing") || v === "value") return "valuing";
  if (v.includes("organization") || v.includes("organisation")) return "organization";
  if (v.includes("characterization")) return "characterization";

  // Cognitive
  if (v.includes("remember")) return "remember";
  if (v.includes("understand")) return "understand";
  if (v.includes("apply")) return "apply";
  if (v.includes("analyze") || v.includes("analyse")) return "analyze";
  if (v.includes("evaluate")) return "evaluate";
  if (v.includes("create")) return "create";

  // Psychomotor
  if (v.includes("perception")) return "perception";
  if (v === "set") return "set";
  if (v.includes("guided")) return "guided response";
  if (v.includes("mechanism")) return "mechanism";
  if (v.includes("complex")) return "complex overt response";
  if (v.includes("adaptation")) return "adaptation";
  if (v.includes("origination")) return "origination";

  return "";
}

/* =========================
   THEME TOGGLE
========================= */
darkToggle.addEventListener('click', () => {
  const curr = document.body.getAttribute('data-theme') || 'light';
  const next = curr === 'light' ? 'dark' : 'light';
  document.body.setAttribute('data-theme', next);
  darkToggle.innerHTML = next === 'dark'
    ? '<i class="bi bi-sun"></i> Light'
    : '<i class="bi bi-moon"></i> Dark';
});

/* =========================
   LOAD MAPPING
========================= */
async function loadMapping() {
  const res = await fetch('/api/mapping');
  MAP = await res.json();

  iegSel.innerHTML = '<option value="">Select IEG</option>';
  (MAP.IEGs || []).forEach(i => iegSel.add(new Option(i, i)));

  ploSel.innerHTML = '<option value="">Select PLO</option>';
}

 
  

  function renderBloomHint() {
  const level = levelSel.value;
  const hintEl = document.getElementById("bloom_hint");

  if (!level || !BLOOM_RECOMMENDATION_BY_LEVEL[level]) {
    hintEl.innerHTML =
      `<span class="muted">Select programme level to see Bloom recommendations.</span>`;
    return;
  }

  const { cognitive, affective, psychomotor, caution } =
    BLOOM_RECOMMENDATION_BY_LEVEL[level];

  hintEl.innerHTML = `
    <div><strong>üß† Cognitive:</strong> ${cognitive.join(", ")}</div>
    <div><strong>‚ù§Ô∏è Affective:</strong> ${affective.join(", ")}</div>
    <div><strong>‚úã Psychomotor:</strong> ${psychomotor.join(", ")}</div>
    ${
      caution?.length
        ? `<div class="mt-1" style="color:#92400e;">
            ‚ö†Ô∏è <strong>Use sparingly:</strong> ${caution.join(", ")}
           </div>`
        : ""
    }
  `;
}


    function updateBloomTag(bloomKey){
  const tag = document.getElementById("bloomTag");
  if(!tag || !bloomKey) return;

  // Cognitive
  if (["remember","understand","apply","analyze","evaluate","create"].includes(bloomKey)){
    const map = {remember:"C1",understand:"C2",apply:"C3",analyze:"C4",evaluate:"C5",create:"C6"};
    tag.textContent = map[bloomKey];
    return;
  }

  // Affective
  if (["receiving","responding","valuing","organization","characterization"].includes(bloomKey)){
    const map = {receiving:"A1",responding:"A2",valuing:"A3",organization:"A4",characterization:"A5"};
    tag.textContent = map[bloomKey];
    return;
  }

  // Psychomotor
  if (["perception","set","guided response","mechanism","complex overt response","adaptation","origination"].includes(bloomKey)){
    const map = {
      perception:"P1",set:"P2","guided response":"P3",
      mechanism:"P4","complex overt response":"P5",
      adaptation:"P6",origination:"P7"
    };
    tag.textContent = map[bloomKey];
    return;
  }

  tag.textContent = "‚Äî";
}

  /* =========================
   BLOOM LEVEL AUTO-HINT
========================= */
levelSel.addEventListener("change", renderBloomHint);


function renderContentSuggestions(domain) {
  const box = contentSuggestionsRight;
  if (!box) return;

  const MAP = {
    cognitive: [
      "clinical concepts",
      "research data analysis",
      "case-based reasoning",
      "theoretical models",
      "evidence-based guidelines"
    ],
    affective: [
      "professional ethics",
      "patient-centred values",
      "interprofessional collaboration",
      "professional responsibility",
      "reflective practice"
    ],
    psychomotor: [
      "laboratory procedures",
      "clinical skill performance",
      "diagnostic testing protocols",
      "equipment handling techniques",
      "professional practice simulations"
    ]
  };

  const list = MAP[domain] || [];
  box.innerHTML = list.length
    ? `<ul class="muted">${list.map(i => `<li>${i}</li>`).join("")}</ul>`
    : `<span class="muted">No suggestions available.</span>`;
}
    
/* =========================
   BLOOM CHANGE (ONLY ONE)
========================= */
bloomSel.addEventListener("change", async () => {
  const raw = bloomSel.value;
  const key = normaliseBloomKey(raw);
  const plo = ploSel.value;

  updateBloomTag(key); 

  console.log("BLOOM:", raw, "‚Üí", key);

   /* Description */
  bloomDescEl.textContent =
    BLOOM_DESC[key] || "Select a Bloom level to see its description.";


/* Assessment + Evidence */
renderAssessmentFromBloom(key);


  // üî• Auto show Assessment tab (if enabled)
if (AUTO_SHOW_ASSESSMENT) {
  const assessTabBtn = document.querySelector('[data-bs-target="#assessmentTab"]');
  if (assessTabBtn) {
    new bootstrap.Tab(assessTabBtn).show();
  }
}
  
  /* Backend verbs + meta */
  if (!plo || !key) return;

  const vres = await fetch(`/api/get_verbs/${encodeURIComponent(plo)}/${encodeURIComponent(key)}?profile=${encodeURIComponent(profileSel.value)}`);
  const verbs = await vres.json();
  verbSel.innerHTML = '<option value="">Select Verb</option>';
  (verbs || []).forEach(v => verbSel.add(new Option(v, v)));

  const mres = await fetch(`/api/get_meta/${encodeURIComponent(plo)}/${encodeURIComponent(key)}?profile=${encodeURIComponent(profileSel.value)}`);
  const meta = await mres.json();

  scCodeEl.textContent = meta.sc_code || '‚Äî';
  scDescEl.textContent = meta.sc_desc || '‚Äî';
  vbeEl.textContent = meta.vbe || '‚Äî';
  domainEl.textContent = meta.domain || '‚Äî';
  conditionEl.textContent = meta.condition || '‚Äî';
  criterionEl.textContent = meta.criterion || '‚Äî';

  renderContentSuggestions(meta.domain);
});

    /* =========================
   IEG ‚Üí PEO
========================= */
iegSel.addEventListener("change", async () => {
  const ieg = iegSel.value;

  peoSel.innerHTML = '<option value="">Select PEO</option>';
  ploSel.innerHTML = '<option value="">Select PLO</option>';

  iegLogicBox.textContent = "‚Äî";
  peoPloLogicBox.textContent = "‚Äî";
  peoStatementEl.textContent = "‚Äî";
  ploStatementEl.textContent = "‚Äî";
  ploIndicatorEl.textContent = "‚Äî";

  if (!ieg) return;

  try {
    const res = await fetch(`/api/get_peos/${encodeURIComponent(ieg)}`);
    const peos = await res.json();

    (peos || []).forEach(p =>
      peoSel.add(new Option(p, p))
    );
  } catch (e) {
    console.error("IEG ‚Üí PEO error", e);
  }

  try {
    const logicRes = await fetch(`/api/logic/ieg_peo/${encodeURIComponent(ieg)}`);
    const txt = await logicRes.text();
    iegLogicBox.textContent = txt?.trim() || "‚Äî";
  } catch (e) {
    console.error("IEG logic error", e);
  }
});

peoSel.addEventListener("change", async () => {
  const peo = peoSel.value;

  ploSel.innerHTML = '<option value="">Select PLO</option>';
  peoPloLogicBox.textContent = "‚Äî";
  peoStatementEl.textContent = "‚Äî";
  ploStatementEl.textContent = "‚Äî";
  ploIndicatorEl.textContent = "‚Äî";

  if (!peo) return;

  /* 1Ô∏è‚É£ Load PLO list */
  try {
    const r = await fetch(`/api/get_plos/${encodeURIComponent(peo)}`);
    const plos = await r.json();
    (plos || []).forEach(p => ploSel.add(new Option(p, p)));
  } catch (e) {
    console.error("PEO ‚Üí PLO list error", e);
  }

  /* 2Ô∏è‚É£ Why PEO ‚Üí PLO (ROBUST DEFAULT) */
  try {
    const logicRes = await fetch(`/api/logic/peo_plo/${encodeURIComponent(peo)}`);
    if (!logicRes.ok) {
      peoPloLogicBox.textContent =
        "The selected Programme Learning Outcomes (PLOs) are directly aligned with the Programme Educational Objective (PEO).";
    } else {
      const txt = await logicRes.text();
      peoPloLogicBox.textContent =
        txt?.trim() ||
        "The selected Programme Learning Outcomes (PLOs) are directly aligned with the Programme Educational Objective (PEO).";
    }
  } catch (e) {
    console.error("PEO ‚Üí PLO logic error", e);
    peoPloLogicBox.textContent =
      "The selected Programme Learning Outcomes (PLOs) are directly aligned with the Programme Educational Objective (PEO).";
  }

  /* 3Ô∏è‚É£ PEO statement */
  try {
    const level = levelSel.value || "Degree";
    const stmtRes = await fetch(
      `/api/get_statement/${encodeURIComponent(level)}/PEO/${encodeURIComponent(peo)}`
    );
    const stmt = await stmtRes.json();
    peoStatementEl.textContent = stmt || "‚Äî";
  } catch (e) {
    console.error("PEO statement error", e);
    peoStatementEl.textContent = "‚Äî";
  }
});

/* =========================
   PLO ‚Üí STATEMENT + INDICATOR + BLOOM (SINGLE SOURCE)
========================= */
ploSel.addEventListener("change", async () => {
  const plo = ploSel.value;

  // üîπ Reset UI related to PLO
  ploStatementEl.textContent = "‚Äî";
  ploIndicatorEl.textContent = "‚Äî";
  bloomSel.innerHTML = '<option value="">Select Bloom</option>';
  verbSel.innerHTML = '<option value="">Select Verb</option>';
  bloomDescEl.textContent = "Select a Bloom level to see its description.";
  assessList.innerHTML = "‚Äî";
  evidenceList.innerHTML = "‚Äî";

  if (!plo) return;

  /* 1Ô∏è‚É£ PLO statement */
  try {
    const level = levelSel.value || "Degree";
    const res = await fetch(
      `/api/get_statement/${encodeURIComponent(level)}/PLO/${encodeURIComponent(plo)}`
    );
    const stmt = await res.json();
    ploStatementEl.textContent = stmt || "‚Äî";
  } catch (e) {
    console.error("PLO statement error", e);
  }

  /* 2Ô∏è‚É£ PLO indicator */
  try {
    ploIndicatorEl.textContent =
      (MAP.PLOIndicators && MAP.PLOIndicators[plo]) || "‚Äî";
  } catch (e) {
    console.error("PLO indicator error", e);
  }

  /* 3Ô∏è‚É£ Load Bloom list */
  try {
    const res = await fetch(
      `/api/get_blooms/${encodeURIComponent(plo)}?profile=${encodeURIComponent(profileSel.value)}`
    );
    const blooms = await res.json();

    (blooms || []).forEach(b => bloomSel.add(new Option(b, b)));

    // üî• Auto-select first Bloom & force change
    if (blooms && blooms.length > 0) {
      bloomSel.value = blooms[0];
      bloomSel.dispatchEvent(new Event("change", { bubbles: true }));
    }
  } catch (e) {
    console.error("PLO ‚Üí Bloom error", e);
  }
});
    
    /* Generate CLO */
    generateBtn.addEventListener('click', async () => {
      if (!ploSel.value || !bloomSel.value || !verbSel.value || !contentInput.value.trim()) {
        alert('Please fill PLO, Bloom, Verb and Content.');
        return;
      }
      busyEl.style.display = 'inline';
      generateBtn.disabled = true;

      const fd = new FormData();
      fd.append('profile', profileSel.value);
      fd.append('level', levelSel.value);
      fd.append('plo', ploSel.value);
      fd.append('bloom', bloomSel.value);
      fd.append('verb', verbSel.value);
      fd.append('content', contentInput.value);
      fd.append('domain', domainEl.textContent);
      fd.append('vbe', vbeEl.textContent);

      logEvent('generate_clo_attempt', { plo: ploSel.value, bloom: bloomSel.value, verb: verbSel.value });

      try {
        const res = await fetch('/generate', { method:'POST', body: fd });
        if (!res.ok) { const err = await res.text().catch(()=> 'server error'); throw new Error(err); }
        const data = await res.json();
        LAST_CLO = data;

        cloText.innerText = data.clo || '';
        cloCard.style.display = 'block';

        variantsPanel.innerHTML = '';
        const opts = data.variants || data.clo_options || {};
        Object.entries(opts).forEach(([label, text]) => {
          const div = document.createElement('div');
          div.className = 'logic-box mb-2';
          div.style.cursor = 'pointer';
          div.innerHTML = `<strong>${label}</strong><div class="mt-1">${text}</div>`;
          div.onclick = () => cloText.innerText = text;
          variantsPanel.appendChild(div);
        });

        variants_list.innerHTML = '';
        Object.entries(opts).forEach(([label, text]) => {
          const p = document.createElement('p');
          p.innerHTML = `<strong>${label}:</strong> ${text}`;
          variants_list.appendChild(p);
        });

       const key = normaliseBloomKey(bloomSel.value);

// üî• Backend boleh override assessment
if (Array.isArray(data.assessments) && data.assessments.length) {
  assessList.innerHTML =
    '<ul>' + data.assessments.map(a => `<li>${a}</li>`).join('') + '</ul>';
}

// üî• Backend override evidence JIKA ADA
if (data.evidence && Object.keys(data.evidence).length) {
  evidenceList.innerHTML =
    Object.entries(data.evidence)
      .map(([k,v]) => `<div><strong>${k}</strong>: ${v.join('; ')}</div>`)
      .join('');
}

        else {
  // ‚úÖ FALLBACK ‚Äî affective & others
  renderAssessmentFromBloom(key);
}


        
// ‚ùå JANGAN letak else ‚Üí biar evidence dari ASSESSMENT_MAP
        peoStatementEl.textContent = data.peo_statement || '‚Äî';
        ploStatementEl.textContent = data.plo_statement || '‚Äî';
        ploIndicatorEl.textContent = data.plo_indicator || '‚Äî';

        logEvent('generate_clo', { plo: ploSel.value, bloom: bloomSel.value, verb: verbSel.value });

      } catch (e) {
        console.error(e);
        alert('Error generating CLO. See console for details.');
        logEvent('generate_clo_error', { error: (e.message || String(e)) });
      } finally {
        busyEl.style.display = 'none';
        generateBtn.disabled = false;
      }
      
      console.log({
      plo: ploSel.value,
      bloom: bloomSel.value,
      verb: verbSel.value,
      domain: domainEl.textContent,
      vbe: vbeEl.textContent
      });

  });
      

    /* Copy CLO */
    copyBtn.addEventListener('click', async () => {
      if (!cloText.innerText) return;
      try {
        await navigator.clipboard.writeText(cloText.innerText);
        copyBtn.innerText = 'Copied';
        setTimeout(()=> copyBtn.innerHTML = '<i class="bi bi-clipboard me-1"></i> Copy', 1200);
        logEvent('copy_clo', { plo: ploSel.value || null });
      } catch(e) { alert('Copy failed'); }
    });

    /* Downloads */
    downloadBtn.addEventListener('click', () => {
      logEvent('download_clo', { plo: ploSel.value || null });
      window.location = '/download';
    });
    downloadRubricBtn.addEventListener('click', () => {
      logEvent('download_rubric', { plo: ploSel.value || null });
      window.location = '/download_rubric';
    });

    /* Toggle variants */
    toggleVariantsBtn.addEventListener('click', () => {
      const hidden = variantsPanel.style.display === 'none' || variantsPanel.style.display === '';
      variantsPanel.style.display = hidden ? 'block' : 'none';
      toggleVariantsBtn.innerText = hidden ? 'Hide variants' : 'Show variants';
      logEvent('variants_toggle', { visible: hidden });
    });

    // tab click events
    document.querySelectorAll('#tabNav .nav-link').forEach(tab => {
      tab.addEventListener('click', () => logEvent('tab_click', { tab: tab.textContent.trim() }));
    });

    ploSel.addEventListener('change', () => logEvent('peo_plo_check', { peo: peoSel.value, plo: ploSel.value }));

    /* init() - call last, after listeners defined */
    (function init(){
      loadMapping();
      renderBloomHint();

      // Make field default to "‚Äî Select Field ‚Äî"
      if (fieldSel) {
        fieldSel.value = "";
        fieldSel.selectedIndex = 0;
      }

      // Clear suggestions on page load
      if (contentSuggestionsEl) {
        contentSuggestionsEl.innerHTML = "";
      }
      if (contentSuggestionsRight) {
        contentSuggestionsRight.innerHTML = "";
      }

      // track page init
      logEvent('page_init', { page: 'generator' });

    })();
  </script>
</body>
</html>

