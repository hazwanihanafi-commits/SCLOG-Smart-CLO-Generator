<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SCLOG — CLO Construction (Quick Mode)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
body { background:#f4f6f9; }
.app-header {
  background:linear-gradient(135deg,#0d6efd,#084298);
  color:#fff; padding:14px 0;
}
.app-header-inner {
  max-width:960px; margin:auto;
  display:flex; justify-content:space-between; align-items:center;
  padding:0 16px;
}
.card-box {
  background:#fff; border-radius:14px;
  padding:22px; box-shadow:0 12px 28px rgba(0,0,0,.08);
  margin-bottom:20px;
}
.info-box {
  background:#f7f8fc; border-left:4px solid #0d6efd;
  padding:14px; border-radius:8px;
}
.warn-box {
  background:#fff3cd; border-left:4px solid #f0ad4e;
  padding:10px; border-radius:6px; font-size:.85rem;
}
.muted { color:#6c757d; }
</style>
</head>

<body>

<header class="app-header">
  <div class="app-header-inner">
    <div>
      <strong>✨ SCLOG</strong><br>
      <small>Smart Course Learning Outcome Generator</small>
    </div>
    <a href="/" class="btn btn-outline-light btn-sm">← Back Main Page</a>
  </div>
</header>

<div class="container my-4" style="max-width:960px">

<div class="card-box">
<h5>⚡ CLO Construction (Quick Mode)</h5>

<div class="mb-3">
<label class="form-label">Programme Level</label>
<select id="level" class="form-select">
  <option value="">Select Level</option>
  <option>Diploma</option>
  <option>Degree</option>
  <option>Master</option>
  <option>PhD</option>
</select>
</div>

<div class="mb-3">
<label class="form-label">Programme Learning Outcome (PLO)</label>
<select id="plo" class="form-select">
  <option value="">Select PLO</option>
  <option>PLO1</option><option>PLO2</option><option>PLO3</option>
  <option>PLO4</option><option>PLO5</option><option>PLO6</option>
  <option>PLO7</option><option>PLO8</option><option>PLO9</option>
  <option>PLO10</option><option>PLO11</option>
</select>
</div>

<div id="ploInfo" class="info-box mb-3" style="display:none">
  <strong id="ploTitle"></strong>
  <div id="ploDesc" class="mt-1"></div>
  <div class="mt-2" style="font-size:.85rem">
    <strong>SC:</strong> <span id="ploSC"></span><br>
    <strong>VBE:</strong> <span id="ploVBE"></span>
  </div>
</div>

<div class="mb-3">
<label class="form-label">Bloom Level</label>
<select id="bloom" class="form-select">
  <option value="">Select Bloom</option>
</select>
<div id="bloomWarn" class="warn-box mt-2" style="display:none"></div>
<div id="bloomDesc" class="muted mt-2" style="font-size:.85rem"></div>
<div id="cloExample" class="muted mt-1" style="font-size:.85rem"></div>
</div>

<div class="mb-3">
<label class="form-label">Action Verb</label>
<select id="verb" class="form-select">
  <option value="">Select Verb</option>
</select>
</div>

<div class="mb-3">
<label class="form-label">Content / Learning Focus</label>
<input id="content" class="form-control" placeholder="e.g. exercise metabolism">
</div>

<button id="generateBtn" class="btn btn-primary w-100">Generate CLO</button>
</div>

<div id="cloCard" class="card-box" style="display:none">
<h6>Generated CLO</h6>
<div id="cloText" class="fw-semibold"></div>
<hr>
<h6>Variants</h6>
<div id="variants"></div>
<hr>
<h6>Suggested Assessments</h6>
<div id="assessments"></div>
<h6 class="mt-2">Suggested Evidence</h6>
<div id="evidence"></div>
</div>

</div>

<script>
const $ = id => document.getElementById(id);

const BLOOM_RECOMMENDATION_BY_LEVEL = {
  Diploma:{ cognitive:["Remember","Understand","Apply"] },
  Degree:{ cognitive:["Understand","Apply","Analyze"] },
  Master:{ cognitive:["Analyze","Evaluate","Create"] },
  PhD:{ cognitive:["Create"] }
};

function normaliseBloomKey(v){
  if(!v) return "";
  v = v.toLowerCase();
  if(v.includes("remember")) return "remember";
  if(v.includes("understand")) return "understand";
  if(v.includes("apply")) return "apply";
  if(v.includes("analy")) return "analyze";
  if(v.includes("evaluate")) return "evaluate";
  if(v.includes("create")) return "create";
  return "";
}

let PLO_MAP = {};
fetch("/static/data/plo_mapping.json")
  .then(r=>r.json())
  .then(d=>PLO_MAP=d);

const levelSel = $("level");
const ploSel = $("plo");
const bloomSel = $("bloom");
const verbSel = $("verb");

/* =========================
   PLO CHANGE
========================= */
ploSel.onchange = async () => {

  const p = PLO_MAP[ploSel.value];
  if(!p){
    $("ploInfo").style.display="none";
    return;
  }

  $("ploInfo").style.display="block";
  $("ploTitle").innerText = `${ploSel.value} — ${p.title}`;
  $("ploDesc").innerText = p.refers_to;
  $("ploSC").innerText = `${p.sc_code} (${p.sc_description})`;
  $("ploVBE").innerText = p.vbe;

  const domain = p.domain.toLowerCase();
  const degree = levelSel.value;

  const res = await fetch(
    `/api/get_blooms/${ploSel.value}?profile=sc`   // ✅ FIX
  );
  const blooms = await res.json();

  const allowed =
    (BLOOM_RECOMMENDATION_BY_LEVEL[degree]?.[domain] || [])
      .map(normaliseBloomKey);

  bloomSel.innerHTML = '<option value="">Select Bloom</option>';

  blooms.forEach(b=>{
    if(allowed.includes(normaliseBloomKey(b))){
      bloomSel.add(new Option(b,b));
    }
  });

  $("bloomWarn").style.display =
    bloomSel.options.length <= 1 ? "block":"none";
};

/* =========================
   LEVEL CHANGE (OUTSIDE) ✅ FIX
========================= */
levelSel.onchange = () => {
  if (ploSel.value) {
    ploSel.dispatchEvent(new Event("change"));
  }
};

/* =========================
   BLOOM CHANGE
========================= */
bloomSel.onchange = async () => {
  const bloomKey = normaliseBloomKey(bloomSel.value);
  if(!bloomKey) return;

  const res = await fetch(
    `/api/get_verbs/${encodeURIComponent(bloomKey)}?profile=sc`
  );
  const verbs = await res.json();

  verbSel.innerHTML = '<option value="">Select Verb</option>';
  (verbs||[]).forEach(v=>verbSel.add(new Option(v,v)));
};
</script>

</body>
</html>
