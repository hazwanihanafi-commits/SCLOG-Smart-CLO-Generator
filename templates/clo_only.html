<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>SCLOG ‚Äî CLO Construction (Quick Mode)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

<style>
body { background:#f4f6f9; }
.app-header {
  background:linear-gradient(135deg,#0d6efd,#084298);
  color:#fff; padding:14px 0;
}
.app-header-inner {
  max-width:960px; margin:auto;
  display:flex; justify-content:space-between; align-items:center;
  padding:0 16px;
}
.card-box {
  background:#fff; border-radius:14px;
  padding:22px; box-shadow:0 12px 28px rgba(0,0,0,.08);
  margin-bottom:20px;
}
.info-box {
  background:#f7f8fc; border-left:4px solid #0d6efd;
  padding:14px; border-radius:8px;
}
.warn-box {
  background:#fff3cd; border-left:4px solid #f0ad4e;
  padding:10px; border-radius:6px; font-size:.85rem;
}
.muted { color:#6c757d; }
</style>
</head>

<body>

<header class="app-header">
  <div class="app-header-inner">
    <div>
      <strong>‚ú® SCLOG</strong><br>
      <small>Smart Course Learning Outcome Generator</small>
    </div>
    <a href="/" class="btn btn-outline-light btn-sm">‚Üê Back Main Page</a>
  </div>
</header>

<div class="container my-4" style="max-width:960px">

<div class="card-box">
<h5>‚ö° CLO Construction (Quick Mode)</h5>

<div class="mb-3">
<label class="form-label">Programme Level</label>
<select id="level" class="form-select">
  <option value="">Select Level</option>
  <option>Diploma</option>
  <option>Degree</option>
  <option>Master</option>
  <option>PhD</option>
</select>
</div>

<div class="mb-3">
<label class="form-label">Programme Learning Outcome (PLO)</label>
<select id="plo" class="form-select">
  <option value="">Select PLO</option>
  <option>PLO1</option><option>PLO2</option><option>PLO3</option>
  <option>PLO4</option><option>PLO5</option><option>PLO6</option>
  <option>PLO7</option><option>PLO8</option><option>PLO9</option>
  <option>PLO10</option><option>PLO11</option>
</select>
</div>

<div id="ploInfo" class="info-box mb-3" style="display:none">
  <strong id="ploTitle"></strong>
  <div id="ploDesc" class="mt-1"></div>
  <div class="mt-2" style="font-size:.85rem">
    <strong>SC:</strong> <span id="ploSC"></span><br>
    <strong>VBE:</strong> <span id="ploVBE"></span>
  </div>
</div>

<div class="mb-3">
<label class="form-label">Bloom Level</label>
<select id="bloom" class="form-select">
  <option value="">Select Bloom</option>
</select>
<div id="bloomWarn" class="warn-box mt-2" style="display:none"></div>
<div id="bloomDesc" class="muted mt-2" style="font-size:.85rem"></div>

</div>

<div class="mb-3">
<label class="form-label">Action Verb</label>
<select id="verb" class="form-select">
  <option value="">Select Verb</option>
</select>
  <div id="cloExample" class="muted mt-1" style="font-size:.85rem"></div>
</div>

<div class="mb-3">
<label class="form-label">Content / Learning Focus</label>
<input id="content" class="form-control" placeholder="e.g. exercise metabolism">
</div>

<button id="generateBtn" class="btn btn-primary w-100">Generate CLO</button>
</div>

<div id="cloCard" class="card-box" style="display:none">
<h6>Generated CLO</h6>
<div id="cloText" class="fw-semibold"></div>
<div class="mt-3 d-flex gap-2 flex-wrap">
  <button id="copyCloBtn" class="btn btn-outline-secondary btn-sm">üìã Copy CLO</button>
  <button id="downloadCloBtn" class="btn btn-outline-primary btn-sm">‚¨áÔ∏è Download CLO</button>
  <button id="downloadRubricBtn" class="btn btn-outline-success btn-sm">üìë Download Rubric</button>
</div>

<hr>
<h6>Variants</h6>
<div id="variants"></div>
<hr>
<h6>Suggested Assessments</h6>
<div id="assessments"></div>
<h6 class="mt-2">Suggested Evidence</h6>
<div id="evidence"></div>
</div>


<script>

 const CLO_EXAMPLE_BY_VERB = {

  /* =========================
     COGNITIVE DOMAIN (MQF)
  ========================= */
  cognitive: {

    remember: {
      identify: "Identify fundamental concepts related to the course content",
      list: "List key principles relevant to the discipline",
      recall: "Recall essential facts and definitions relevant to professional practice",
      recognize: "Recognize basic concepts and terminology used in the field"
    },

    understand: {
      explain: "Explain core concepts using appropriate terminology",
      describe: "Describe processes involved in the selected topic",
      summarize: "Summarize key ideas and concepts accurately",
      interpret: "Interpret information and concepts presented in different formats"
    },

    apply: {
      apply: "Apply theoretical knowledge to solve practical problems",
      demonstrate: "Demonstrate the application of concepts in real-world contexts",
      use: "Use appropriate methods or procedures to complete assigned tasks",
      implement: "Implement relevant techniques to address structured problems"
    },

    analyze: {
      analyze: "Analyse data to identify patterns and relationships",
      examine: "Examine evidence to support informed decision making",
      differentiate: "Differentiate components of complex information or problems",
      compare: "Compare alternative approaches or solutions critically"
    },

    evaluate: {
      evaluate: "Evaluate solutions based on established criteria",
      justify: "Justify decisions using relevant evidence and reasoning",
      critique: "Critique existing practices or solutions using professional standards",
      assess: "Assess outcomes or processes to support informed judgments"
    },

    create: {
      design: "Design solutions to address complex disciplinary problems",
      develop: "Develop proposals that integrate knowledge and skills",
      formulate: "Formulate innovative solutions or models for complex issues",
      construct: "Construct original outputs that demonstrate synthesis of ideas"
    }
  },

  /* =========================
     AFFECTIVE DOMAIN (MQF)
     PLO4, PLO5, PLO8, PLO9, PLO11
  ========================= */
  affective: {

    /* Receiving (Diploma‚ÄìDegree) */
    receiving: {
      listen: "Demonstrate awareness of appropriate professional communication by listening attentively",
      observe: "Observe professional values demonstrated in academic or workplace settings",
      acknowledge: "Acknowledge the importance of ethical and professional practices"
    },

    /* Responding (Diploma‚ÄìDegree) */
    responding: {
      participate: "Participate actively in collaborative learning and professional discussions",
      discuss: "Discuss issues respectfully with peers and stakeholders",
      communicate: "Communicate ideas and information clearly in professional interactions",
      respond: "Respond appropriately to feedback and professional instructions"
    },

    /* Valuing (Degree‚ÄìMaster) */
    valuing: {
      demonstrate: "Demonstrate commitment to professional and ethical values",
      support: "Support ethical decision making in professional contexts",
      justify: "Justify professional viewpoints ethically through oral or written communication",
      advocate: "Advocate responsible and ethical practices within the discipline"
    },

    /* Organization (Master‚ÄìPhD) */
    organization: {
      integrate: "Integrate professional values into decision making and communication practices",
      organize: "Organize communication strategies to support effective teamwork",
      coordinate: "Coordinate professional communication within multidisciplinary teams"
    },

    /* Characterization (PhD) */
    characterization: {
      uphold: "Uphold ethical and professional values consistently in all professional activities",
      model: "Model integrity and professionalism in leadership and scholarly communication",
      internalize: "Internalize ethical values as a guiding principle in professional practice"
    }
  },

  /* =========================
     PSYCHOMOTOR DOMAIN (MQF)
  ========================= */
  psychomotor: {

    perception: {
      detect: "Detect relevant cues or signals required for task performance",
      recognize: "Recognize appropriate tools and equipment for professional tasks"
    },

    set: {
      prepare: "Prepare appropriately for professional tasks and procedures",
      demonstrate: "Demonstrate readiness to perform required skills safely"
    },

    "guided response": {
      perform: "Perform skills under guidance following established procedures",
      practice: "Practice professional skills with supervision and feedback"
    },

    mechanism: {
      execute: "Execute professional skills competently with minimal supervision",
      carry_out: "Carry out standard procedures accurately and efficiently"
    },

    "complex overt response": {
      perform: "Perform complex professional skills smoothly and accurately",
      manage: "Manage integrated tasks requiring coordination of multiple skills"
    },

    adaptation: {
      adapt: "Adapt learned skills to suit new or changing professional situations",
      modify: "Modify procedures to address non-routine or complex conditions"
    },

    origination: {
      create: "Create new procedures or skill sequences to address novel problems",
      design: "Design innovative approaches to professional practice"
    }
  }
};


 const PLO_SC_VBE = {
  PLO1: { sc_code: "SC2", sc_desc: "Anticipatory thinking", vbe: "Ethics and Professionalism" },
  PLO2: { sc_code: "SC6", sc_desc: "Integrated problem solving", vbe: "Ethics and Professionalism" },
  PLO3: { sc_code: "SC4", sc_desc: "Strategic thinking", vbe: "Professional practice standards" },
  PLO4: { sc_code: "SC5", sc_desc: "Collaboration", vbe: "Integrity" },
  PLO5: { sc_code: "SC8", sc_desc: "Normative thinking", vbe: "Ethics and Etiquette" },
  PLO6: { sc_code: "SC8", sc_desc: "Systems thinking", vbe: "Ethics and Professionalism" },
  PLO7: { sc_code: "SC6", sc_desc: "Integrated problem solving", vbe: "Ethics and Professionalism" },
  PLO8: { sc_code: "SC9", sc_desc: "Leadership", vbe: "Professionalism and Teamwork" },
  PLO9: { sc_code: "SC7", sc_desc: "Self-awareness", vbe: "Professionalism and Well-being" },
  PLO10:{ sc_code: "ENT", sc_desc: "Entrepreneurial thinking", vbe: "Honesty and Integrity" },
  PLO11:{ sc_code: "ETH", sc_desc: "Ethical awareness", vbe: "Professional conduct" }
};
  
const $ = id => document.getElementById(id);

const BLOOM_RECOMMENDATION_BY_LEVEL = {
  Diploma:{
    cognitive:["Remember","Understand","Apply"],
    affective:["Receiving","Responding"],
    psychomotor:["Perception","Set","Guided Response"]
  },
  Degree:{
    cognitive:["Understand","Apply","Analyze"],
    affective:["Responding","Valuing"],
    psychomotor:["Guided Response","Mechanism"]
  },
  Master:{
    cognitive:["Analyze","Evaluate","Create"],
    affective:["Valuing","Organization"],
    psychomotor:["Complex Overt Response","Adaptation"]
  },
  PhD:{
    cognitive:["Create"],
    affective:["Characterization"],
    psychomotor:["Adaptation","Origination"]
  }
};

function normaliseBloomKey(v){
  if(!v) return "";
  v = v.toLowerCase();

  // Cognitive
  if(v.includes("remember")) return "remember";
  if(v.includes("understand")) return "understand";
  if(v.includes("apply")) return "apply";
  if(v.includes("analy")) return "analyze";
  if(v.includes("evaluate")) return "evaluate";
  if(v.includes("create")) return "create";

  // Affective
  if(v.includes("receiv")) return "receiving";
  if(v.includes("respond")) return "responding";
  if(v.includes("valu")) return "valuing";
  if(v.includes("organ")) return "organization";
  if(v.includes("character")) return "characterization";

  // Psychomotor
  if(v.includes("guided")) return "guided response";
  if(v.includes("mechanism")) return "mechanism";
  if(v.includes("complex")) return "complex overt response"; 
  if(v.includes("adaptation")) return "adaptation";
  if(v.includes("origination")) return "origination";
  if(v.includes("perception")) return "perception";
  if(v === "set") return "set";

  return "";
}

let PLO_MAP = {};
fetch("/clo-only/plo-mapping")
  .then(r => r.json())
  .then(d => {
    PLO_MAP = d;
  });


const levelSel = $("level");
const ploSel = $("plo");
const bloomSel = $("bloom");
const verbSel = $("verb");

/* =========================
   PLO CHANGE
========================= */
ploSel.onchange = async () => {

  const p = PLO_MAP[ploSel.value];
  if(!p){
    $("ploInfo").style.display="none";
    return;
  }

  $("ploInfo").style.display="block";
  $("ploTitle").innerText = `${ploSel.value} ‚Äî ${p.title}`;
  $("ploDesc").innerText = p.refers_to;
  $("ploSC").innerText = `${p.sc_code} (${p.sc_description})`;
  $("ploVBE").innerText = p.vbe;

  const domain = p.domain.toLowerCase();
  const degree = levelSel.value;

  const res = await fetch(
    `/api/get_blooms/${ploSel.value}?profile=sc`   // ‚úÖ FIX
  );
  const blooms = await res.json();

  const allowed =
    (BLOOM_RECOMMENDATION_BY_LEVEL[degree]?.[domain] || [])
      .map(normaliseBloomKey);

  bloomSel.innerHTML = '<option value="">Select Bloom</option>';

  blooms.forEach(b=>{
    if(allowed.includes(normaliseBloomKey(b))){
      bloomSel.add(new Option(b,b));
    }
  });

  $("bloomWarn").style.display =
    bloomSel.options.length <= 1 ? "block":"none";
};


 verbSel.onchange = () => {
  const verb = verbSel.value?.toLowerCase();
  if (!verb) return;

  const plo = ploSel.value;
  if (!plo || !PLO_MAP[plo] || !PLO_SC_VBE[plo]) return;

  const domain = PLO_MAP[plo].domain.toLowerCase();
  const bloomKey = normaliseBloomKey(bloomSel.value);

  const scInfo = PLO_SC_VBE[plo];
  const scText = `${scInfo.sc_code} (${scInfo.sc_desc.toLowerCase()})`;
  const vbeText = scInfo.vbe.toLowerCase();

  const baseExample =
    CLO_EXAMPLE_BY_VERB?.[domain]?.[bloomKey]?.[verb];

  const finalExample = baseExample
    ? `${baseExample} using ${scText}, guided by ${vbeText}.`
    : "";

  const ruleMessage =
  "Example CLO is provided selectively for representative action verbs that " +
  "demonstrate good practice in CLO construction. " +
  "This verb requires contextual formulation by the course lecturer.";

document.getElementById("cloExample").innerHTML = baseExample
  ? `<strong>Example CLO (SC & VBE aligned):</strong><br>
     ${baseExample} using ${scText}, guided by ${vbeText}.`
  : `<em>${ruleMessage}</em>`;
}; 
/* =========================
   LEVEL CHANGE (OUTSIDE) ‚úÖ FIX
========================= */
levelSel.onchange = () => {
  if (ploSel.value) {
    ploSel.dispatchEvent(new Event("change"));
  }
};

/* =========================
   BLOOM CHANGE
========================= */
bloomSel.onchange = async () => {
  const bloomKey = normaliseBloomKey(bloomSel.value);
  if(!bloomKey) return;

  const res = await fetch(
    `/api/get_verbs/${encodeURIComponent(bloomKey)}?profile=sc`
  );
  const verbs = await res.json();

  verbSel.innerHTML = '<option value="">Select Verb</option>';
  (verbs||[]).forEach(v=>verbSel.add(new Option(v,v)));
};


document.getElementById("generateBtn").onclick = async () => {

  const plo = ploSel.value;
  const bloom = bloomSel.value;
  const verb = verbSel.value;
  const content = document.getElementById("content").value.trim();
  const level = levelSel.value;

  if (!plo || !bloom || !verb || !content || !level) {
    alert("Please complete Programme Level, PLO, Bloom, Verb, and Content.");
    return;
  }

  // ‚úÖ DEFINE ploObj FIRST
  const ploObj = PLO_MAP[plo];

  if (!ploObj || !ploObj.title || !ploObj.domain) {
    alert("PLO reference data failed to load. Please refresh the page.");
    return;
  }

  const fd = new FormData();
  fd.append("profile", "sc");

  fd.append("plo", plo);                         // legacy
  fd.append("plo_code", plo);
  fd.append("plo_title", ploObj.title);
  fd.append("plo_domain", ploObj.domain);
  fd.append("plo_sc", ploObj.sc_code);
  fd.append("plo_vbe", ploObj.vbe);

  fd.append("bloom", bloom);
  fd.append("bloom_key", normaliseBloomKey(bloom));
  fd.append("verb", verb);
  fd.append("content", content);
  fd.append("level", level);

  try {
    const res = await fetch("/clo-only/generate", {
      method: "POST",
      body: fd
    });

    if (!res.ok) {
      const err = await res.json();
      alert(err.error || "Failed to generate CLO");
      return;
    }

    const data = await res.json();
    window.lastCloResponse = data;

    document.getElementById("cloCard").style.display = "block";
    document.getElementById("cloText").innerText = data.clo;

    document.getElementById("variants").innerHTML =
      Object.entries(data.variants || {})
        .map(([k,v]) => `<div><strong>${k}:</strong> ${v}</div>`)
        .join("");

    document.getElementById("assessments").innerHTML =
      "<ul>" + (data.assessments || []).map(a => `<li>${a}</li>`).join("") + "</ul>";

    document.getElementById("evidence").innerHTML =
      Object.entries(data.evidence || {})
        .map(([k,v]) => `<div><strong>${k}</strong>: ${v.join(", ")}</div>`)
        .join("");

  } catch (e) {
    console.error(e);
    alert("Error generating CLO. See console.");
  }
};

  document.getElementById("copyCloBtn").onclick = () => {
  const text = document.getElementById("cloText").innerText;
  navigator.clipboard.writeText(text).then(() => {
    alert("CLO copied to clipboard!");
  });
};

  document.getElementById("downloadCloBtn").onclick = async () => {
  const payload = window.lastCloResponse; // we‚Äôll store this below

  const res = await fetch("/clo-only/download", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const blob = await res.blob();
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "CLO.xlsx";
  a.click();

  window.URL.revokeObjectURL(url);
};

  document.getElementById("downloadRubricBtn").onclick = async () => {
  const payload = window.lastCloResponse;

  const res = await fetch("/clo-only/download-rubric", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const blob = await res.blob();
  const url = window.URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "CLO_Rubric.xlsx";
  a.click();

  window.URL.revokeObjectURL(url);
};



</script>


</body>
</html>
