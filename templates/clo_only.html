<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SCLOG — Workflow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    body { background-color: #f4f6f9; }

    .app-header {
      background: linear-gradient(135deg, #0d6efd, #084298);
      color: white;
      padding: 0.9rem 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .step-card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.08);
      padding: 1.75rem;
    }

    .step-title { font-weight: 600; margin-bottom: .5rem; }
    .step-desc { font-size: .9rem; color: #6c757d; margin-bottom: 1rem; }

    #cloCard {
      background: #f8fafc;
      border-left: 4px solid #0d6efd;
    }
  </style>
</head>

<body>

<!-- ===== HEADER ===== -->
<div class="app-header">
  <div class="container d-flex justify-content-between align-items-center">
    <h5 class="mb-0">SCLOG — Workflow</h5>
    <a href="/app" class="btn btn-outline-light btn-sm rounded-pill px-3">
      <i class="bi bi-arrow-left"></i> Back to Workflow
    </a>
  </div>
</div>

<!-- ===== CONTENT ===== -->
<div class="container my-4" style="max-width:900px">

  <div class="step-card">

    <div class="step-title">⚡ CLO Construction (Quick Mode)</div>
    <div class="step-desc">
      Generate Course Learning Outcomes aligned with Bloom taxonomy,
      Scientific Core (SC), and Values-Based Education (VBE).
    </div>

    <!-- DEGREE -->
    <div class="mb-3">
      <label class="form-label">Degree Level</label>
      <select id="degree" class="form-select">
        <option value="">Select Degree</option>
        <option>Diploma</option>
        <option>Bachelor</option>
        <option>Master</option>
        <option>PhD</option>
      </select>
    </div>

    <!-- PLO -->
    <div class="mb-3">
      <label class="form-label">Programme Learning Outcome (PLO)</label>
      <select id="plo" class="form-select">
        <option value="">Select PLO</option>
        <option>PLO1</option><option>PLO2</option><option>PLO3</option>
        <option>PLO4</option><option>PLO5</option><option>PLO6</option>
        <option>PLO7</option><option>PLO8</option><option>PLO9</option>
        <option>PLO10</option><option>PLO11</option>
      </select>
    </div>

    <!-- BLOOM -->
    <div class="mb-2">
      <label class="form-label">Bloom Level</label>
      <select id="bloom" class="form-select">
        <option value="">Select Bloom</option>
      </select>

      <div id="bloomDesc" class="text-muted small mt-1"></div>
      <div id="bloomWarn" class="alert alert-warning py-2 px-3 mt-2" style="display:none"></div>
    </div>

    <!-- VERB -->
    <div class="mb-3">
      <label class="form-label">Action Verb</label>
      <select id="verb" class="form-select">
        <option value="">Select Verb</option>
      </select>
    </div>

    <!-- CONTENT -->
    <div class="mb-4">
      <label class="form-label">Content / Learning Focus</label>
      <input id="content" class="form-control"
             placeholder="e.g. exercise metabolism">
    </div>

    <!-- GENERATE -->
    <button id="generateBtn" class="btn btn-primary w-100 mb-3">
      Generate CLO
    </button>

    <!-- OUTPUT -->
    <div id="cloCard" class="card p-3 mb-3" style="display:none">
      <strong>Generated CLO</strong>
      <div id="clo_text" class="mt-2"></div>

      <hr>
      <h6>Variants</h6>
      <div id="variantBox"></div>

      <hr>
      <h6>Suggested Assessments</h6>
      <div id="assessmentBox"></div>

      <h6 class="mt-3">Suggested Evidence</h6>
      <div id="evidenceBox"></div>
    </div>

    <!-- DOWNLOAD -->
    <button id="downloadBtn" class="btn btn-success w-100 mb-2">
      Download CLO (Excel)
    </button>

    <button id="rubricBtn" class="btn btn-outline-secondary w-100">
      Download Rubric
    </button>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const $ = id => document.getElementById(id);

  const degreeSel = $("degree");
  const ploSel = $("plo");
  const bloomSel = $("bloom");
  const verbSel = $("verb");
  const contentInput = $("content");

  const bloomDesc = $("bloomDesc");
  const bloomWarn = $("bloomWarn");

  const cloCard = $("cloCard");
  const cloText = $("clo_text");
  const variantBox = $("variantBox");
  const assessmentBox = $("assessmentBox");
  const evidenceBox = $("evidenceBox");

  const downloadBtn = $("downloadBtn");
  const rubricBtn = $("rubricBtn");

  let generatedData = null;

  /* =============================
     LOAD BLOOMS (degree + plo)
  ============================= */
  async function loadBlooms() {
    bloomSel.innerHTML = '<option value="">Select Bloom</option>';
    verbSel.innerHTML = '<option value="">Select Verb</option>';
    bloomDesc.textContent = "";
    bloomWarn.style.display = "none";

    if (!degreeSel.value || !ploSel.value) return;

    const res = await fetch(
      `/api/get_blooms/${encodeURIComponent(ploSel.value)}?degree=${encodeURIComponent(degreeSel.value)}`
    );
    const blooms = await res.json();
    (blooms || []).forEach(b => bloomSel.add(new Option(b, b)));
  }

  degreeSel.addEventListener("change", loadBlooms);
  ploSel.addEventListener("change", loadBlooms);

  /* =============================
     BLOOM CHANGE
  ============================= */
  bloomSel.addEventListener("change", async () => {
    bloomDesc.textContent = "";
    bloomWarn.style.display = "none";
    verbSel.innerHTML = '<option value="">Select Verb</option>';

    if (!bloomSel.value || !ploSel.value) return;

    /* Bloom description */
    const dRes = await fetch(
      `/api/clo-only/bloom-desc/${encodeURIComponent(ploSel.value)}/${encodeURIComponent(bloomSel.value)}`
    );
    bloomDesc.textContent = await dRes.json();

    /* Load verbs */
    const vRes = await fetch(
      `/api/get_verbs/${encodeURIComponent(ploSel.value)}/${encodeURIComponent(bloomSel.value)}`
    );
    const verbs = await vRes.json();
    (verbs || []).forEach(v => verbSel.add(new Option(v, v)));
  });

  /* =============================
     GENERATE CLO
  ============================= */
  $("generateBtn").addEventListener("click", async () => {
    if (!degreeSel.value || !ploSel.value || !bloomSel.value ||
        !verbSel.value || !contentInput.value.trim()) {
      alert("Please complete all fields.");
      return;
    }

    const fd = new FormData();
    fd.append("degree", degreeSel.value);
    fd.append("plo", ploSel.value);
    fd.append("bloom", bloomSel.value);
    fd.append("verb", verbSel.value);
    fd.append("content", contentInput.value.trim());

    const res = await fetch("/clo-only/generate", { method:"POST", body: fd });
    const data = await res.json();

    if (data.error) {
      alert(data.error);
      return;
    }

    generatedData = data;

    cloText.innerText = data.clo;
    variantBox.innerHTML =
      Object.entries(data.variants || {})
        .map(([k,v]) => `<p><strong>${k}:</strong> ${v}</p>`)
        .join("");

    assessmentBox.innerHTML =
      "<ul>" + (data.assessments || []).map(a => `<li>${a}</li>`).join("") + "</ul>";

    evidenceBox.innerHTML =
      Object.entries(data.evidence || {})
        .map(([k,v]) => `<div><strong>${k}</strong>: ${v.join(", ")}</div>`)
        .join("");

    cloCard.style.display = "block";
  });

  /* =============================
     DOWNLOAD CLO
  ============================= */
  downloadBtn.addEventListener("click", async () => {
    if (!generatedData) {
      alert("Generate CLO first.");
      return;
    }

    const res = await fetch("/clo-only/download", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(generatedData)
    });

    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "CLO_Only.xlsx";
    a.click();
  });

  /* =============================
     DOWNLOAD RUBRIC
  ============================= */
  rubricBtn.addEventListener("click", async () => {
    if (!generatedData) {
      alert("Generate CLO first.");
      return;
    }

    const res = await fetch("/clo-only/download-rubric", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(generatedData)
    });

    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "CLO_Rubric.xlsx";
    a.click();
  });

});
</script>

</body>
</html>
