<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>SCLOG — CLO Only Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light p-4">

<div class="container" style="max-width:720px">

  <h3 class="mb-4">⚡ CLO Only Generator</h3>

  <!-- DEGREE -->
  <div class="mb-3">
    <label class="form-label">Degree Level</label>
    <select id="degree" class="form-select">
      <option value="">Select Degree</option>
      <option>Diploma</option>
      <option>Bachelor</option>
      <option>Master</option>
      <option>PhD</option>
    </select>
  </div>

  <!-- PLO -->
  <div class="mb-3">
    <label class="form-label">Programme Learning Outcome (PLO)</label>
    <select id="plo" class="form-select">
      <option value="">Select PLO</option>
      <option>PLO1</option>
      <option>PLO2</option>
      <option>PLO3</option>
      <option>PLO4</option>
      <option>PLO5</option>
      <option>PLO6</option>
      <option>PLO7</option>
      <option>PLO8</option>
      <option>PLO9</option>
      <option>PLO10</option>
      <option>PLO11</option>
    </select>
  </div>

  <!-- BLOOM -->
  <div class="mb-3">
    <label class="form-label">Bloom Level</label>
    <select id="bloom" class="form-select">
      <option value="">Select Bloom</option>
    </select>
  </div>

  <!-- VERB -->
  <div class="mb-3">
    <label class="form-label">Action Verb</label>
    <select id="verb" class="form-select">
      <option value="">Select Verb</option>
    </select>
  </div>

  <!-- CONTENT -->
  <div class="mb-3">
    <label class="form-label">Content / Learning Focus</label>
    <input id="content" class="form-control"
      placeholder="e.g. ECG waveform abnormalities">
  </div>

  <button id="generateBtn" class="btn btn-primary w-100 mb-3">
    Generate CLO
  </button>

  <!-- OUTPUT -->
  <div id="cloCard" class="card p-3 mb-3" style="display:none">
    <strong>Generated CLO</strong>
    <div id="clo_text" class="mt-2"></div>
  </div>

  <button id="downloadBtn" class="btn btn-success w-100">
    Download CLO (Excel)
  </button>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const $ = id => document.getElementById(id);

  const degreeSel = $("degree");
  const ploSel    = $("plo");
  const bloomSel  = $("bloom");
  const verbSel   = $("verb");
  const content   = $("content");

  const cloCard = $("cloCard");
  const cloText = $("clo_text");

  let generatedData = null;

  /* ---------------------------
     DEGREE / PLO → BLOOM
  --------------------------- */
  async function loadBlooms() {
    bloomSel.innerHTML = `<option value="">Select Bloom</option>`;
    verbSel.innerHTML  = `<option value="">Select Verb</option>`;

    if (!ploSel.value || !degreeSel.value) return;

    const res = await fetch(
      `/api/get_blooms/${ploSel.value}?degree=${degreeSel.value}`
    );
    const blooms = await res.json();
    blooms.forEach(b => bloomSel.add(new Option(b, b)));
  }

  degreeSel.addEventListener("change", loadBlooms);
  ploSel.addEventListener("change", loadBlooms);

  /* ---------------------------
     BLOOM → VERB
  --------------------------- */
  bloomSel.addEventListener("change", async () => {
    verbSel.innerHTML = `<option value="">Select Verb</option>`;
    if (!bloomSel.value || !ploSel.value) return;

    const res = await fetch(
      `/api/get_verbs/${ploSel.value}/${bloomSel.value}`
    );
    const verbs = await res.json();
    verbs.forEach(v => verbSel.add(new Option(v, v)));
  });

  /* ---------------------------
     GENERATE CLO (CLO-ONLY)
  --------------------------- */
  $("generateBtn").addEventListener("click", async () => {

    if (!degreeSel.value || !ploSel.value || !bloomSel.value ||
        !verbSel.value || !content.value.trim()) {
      alert("Please complete all fields.");
      return;
    }

    const fd = new FormData();
    fd.append("degree", degreeSel.value);
    fd.append("plo", ploSel.value);
    fd.append("bloom", bloomSel.value);
    fd.append("verb", verbSel.value);
    fd.append("content", content.value.trim());

    const res = await fetch("/clo-only/generate", {
      method: "POST",
      body: fd
    });

    const data = await res.json();
    if (data.error) {
      alert(data.error);
      return;
    }

    generatedData = data;

    cloText.innerText = data.clo;
    cloCard.style.display = "block";
  });

  /* ---------------------------
     DOWNLOAD (POST, STATELESS)
  --------------------------- */
  $("downloadBtn").addEventListener("click", async () => {
    if (!generatedData) {
      alert("Generate CLO first.");
      return;
    }

    const res = await fetch("/clo-only/download", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(generatedData)
    });

    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "CLO_Only.xlsx";
    a.click();
  });

});
</script>

</body>
</html>
